<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FYS - For Yourself</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FYS">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#0a0a0a">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* ============================================ */
        /* PREMIUM LOADING SCREEN - BITPANDA STYLE */
        /* ============================================ */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(180deg, #050505 0%, #0B0B0B 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 600ms cubic-bezier(0.4, 0.0, 0.2, 1),
                        visibility 600ms cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        #loadingScreen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .loading-logo-container {
            width: 38vw;
            max-width: 240px;
            position: relative;
        }
        
        .loading-logo {
            width: 100%;
            height: auto;
            display: block;
            opacity: 0;
            animation: logoFadeIn 400ms cubic-bezier(0.4, 0.0, 0.2, 1) forwards,
                       logoArrowRise 700ms ease-out 400ms forwards,
                       logoGlowPulse 600ms ease-out 1100ms forwards;
        }
        
        @keyframes logoFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes logoArrowRise {
            from {
                transform: translateY(12px) rotate(-6deg);
            }
            to {
                transform: translateY(0) rotate(0deg);
            }
        }
        
        @keyframes logoGlowPulse {
            0% {
                filter: drop-shadow(0 0 0 rgba(255, 165, 0, 0));
            }
            50% {
                filter: drop-shadow(0 0 18px rgba(255, 165, 0, 0.35));
            }
            100% {
                filter: drop-shadow(0 0 0 rgba(255, 165, 0, 0));
            }
        }
        
        /* ============================================ */
        /* APP HEADER LOGO */
        /* ============================================ */
        .header-logo-fys {
            position: fixed;
            top: 14px;
            left: 16px;
            height: 28px;
            width: auto;
            z-index: 999; /* Above all views except modals */
            pointer-events: none; /* Logo is decorative, not clickable */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root[data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-card: #111111;
            --bg-elevated: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #6b6b6b;
            --text-tertiary: #404040;
            --accent-primary: #ff6b35;
            --accent-up: #00ff88;
            --accent-down: #ff3366;
            --border: #1a1a1a;
            --border-light: #2a2a2a;
        }

        :root[data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-elevated: #ffffff;
            --text-primary: #ff6b35;
            --text-secondary: #ff8f5f;
            --text-tertiary: #ffb89d;
            --accent-primary: #ff6b35;
            --accent-up: #00c96d;
            --accent-down: #ff3366;
            --border: #ffe8e0;
            --border-light: #fff5f0;
        }
        /* ============================================
           Loading Screen - Modern Design (Website Style)
           ============================================ */

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #000000 0%, #0d0d0d 100%);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 1s ease, visibility 1s ease;
            overflow: hidden;
        }

        .loading-screen::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(255, 107, 53, 0.08), transparent 65%);
            border-radius: 50%;
            pointer-events: none;
            animation: glowPulse 5s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.3;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 0.6;
            }
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
            position: relative;
        }

        .loading-logo {
            width: 240px;
            height: 120px;
            position: relative;
            margin: 0 auto;
        }
        
        /* Professional FYS Loading Logo */
        .fys-loading-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 12px 40px rgba(255, 107, 53, 0.4));
            animation: logoFloat 4s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        /* Animated Arrow in Loading Screen */
        .loading-arrow-anim path {
            animation: loadingArrowDraw 2.5s cubic-bezier(0.65, 0, 0.35, 1) infinite;
        }
        
        .loading-arrow-anim polyline {
            animation: loadingArrowFade 2.5s cubic-bezier(0.65, 0, 0.35, 1) infinite;
        }
        
        @keyframes loadingArrowDraw {
            0% {
                stroke-dashoffset: 60;
                opacity: 0;
            }
            20% {
                opacity: 1;
            }
            60% {
                stroke-dashoffset: 0;
            }
            85%, 100% {
                stroke-dashoffset: 0;
                opacity: 0;
            }
        }
        
        @keyframes loadingArrowFade {
            0%, 50% {
                opacity: 0;
                transform: translateY(3px);
            }
            60% {
                opacity: 1;
                transform: translateY(0);
            }
            85%, 100% {
                opacity: 0;
                transform: translateY(-3px);
            }
        }

        /* Legacy loading styles removed */

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeOut 0.5s 2s forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                pointer-events: none;
            }
        }

        .logo-container {
            position: relative;
            width: 180px;
            height: 180px;
            margin-bottom: 32px;
        }

        .logo-circle {
            position: absolute;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(40, 30, 20, 1) 0%, rgba(20, 15, 10, 1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 60px rgba(255, 107, 53, 0.4),
                        inset 0 0 40px rgba(0, 0, 0, 0.6);
        }

        .logo-ring {
            position: absolute;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 10px solid transparent;
            border-top-color: #ff6b35;
            border-right-color: #ff6b35;
            border-bottom-color: #ff6b35;
            animation: rotate 3s linear infinite;
            filter: drop-shadow(0 0 20px rgba(255, 107, 53, 0.6));
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .logo-segment-1 {
            position: absolute;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 10px solid transparent;
            border-top-color: #ff6b35;
            transform: rotate(45deg);
            opacity: 0.6;
        }

        .logo-segment-2 {
            position: absolute;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 10px solid transparent;
            border-bottom-color: #ff6b35;
            transform: rotate(135deg);
            opacity: 0.6;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .logo-text {
            font-size: 42px;
            font-weight: 900;
            color: #000;
            letter-spacing: -2px;
        }

        .brand-tagline {
            font-size: 18px;
            font-weight: 700;
            color: #ff6b35;
            text-transform: uppercase;
            letter-spacing: 3px;
            animation: fadeIn 0.8s 0.5s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            padding-bottom: 110px;
            min-height: 100vh;
        }

        /* Header with Logo */
        .header {
            background: var(--bg-secondary);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ============================================ */
        /* PROFESSIONAL FYS LOGO - HEADER */
        /* ============================================ */
        .logo-fys-header {
            display: flex;
            align-items: center;
        }

        .fys-logo-svg {
            width: 80px;
            height: 40px;
            filter: drop-shadow(0 2px 8px rgba(255, 107, 53, 0.3));
        }

        /* Subtle Arrow Animation in Logo */
        .arrow-animated path {
            animation: arrowDraw 3s ease-in-out infinite;
        }

        .arrow-animated polyline {
            animation: arrowFade 3s ease-in-out infinite;
        }

        @keyframes arrowDraw {
            0%, 100% {
                stroke-dashoffset: 30;
                opacity: 0;
            }
            30% {
                opacity: 1;
            }
            60% {
                stroke-dashoffset: 0;
            }
            90% {
                opacity: 0;
            }
        }

        @keyframes arrowFade {
            0%, 50% {
                opacity: 0;
            }
            60% {
                opacity: 1;
            }
            90%, 100% {
                opacity: 0;
            }
        }

        .header-date {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Home View */
        .home-content {
            padding: 20px;
            padding-top: 0; /* No top padding - widget starts at very top */
            position: relative; /* Enable stacking context for z-index */
        }

        .index-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-tertiary);
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
        }

        .main-chart-section {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .main-chart-section:active {
            transform: scale(0.98);
        }

        .main-chart-container {
            position: relative;
            height: 220px;
            margin-bottom: 20px;
        }

        .index-value-display {
            text-align: center;
        }

        .index-value-number {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: -2px;
            line-height: 1;
            margin-bottom: 8px;
        }

        .index-value-number.positive {
            color: var(--accent-up);
        }

        .index-value-number.negative {
            color: var(--accent-down);
        }

        .index-change-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .tap-hint {
            text-align: center;
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-tertiary);
            opacity: 0.6;
        }

        .time-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            position: relative; /* NEW: Enable stacking */
            z-index: 10; /* NEW: Above other content */
            padding: 4px;
            background: var(--bg-secondary);
            border-radius: 16px;
        }

        .time-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            font-family: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .time-btn.active {
            background: var(--accent-primary);
            color: #000; /* Dark text in dark mode */
            border-color: var(--accent-primary);
        }
        
        /* Light Mode: White text on orange */
        :root[data-theme="light"] .time-btn.active {
            color: #ffffff;
        }

        /* Glassmorphism für alle Cards */
        .widget-card,
        .main-chart-section,
        .chart-card,
        .stock-list-container,
        .journal-calendar,
        .journal-entry-section,
        .category-chart-card {
            background: rgba(17, 17, 17, 0.6) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        [data-theme="light"] .widget-card,
        [data-theme="light"] .main-chart-section,
        [data-theme="light"] .chart-card,
        [data-theme="light"] .stock-list-container,
        [data-theme="light"] .journal-calendar,
        [data-theme="light"] .journal-entry-section,
        [data-theme="light"] .category-chart-card {
            background: rgba(255, 255, 255, 0.7) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08),
                        inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        /* Widget Cards */
        .widget-card {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .widget-card:active {
            transform: scale(0.98);
        }

        .widget-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .widget-title {
            font-size: 16px;
            font-weight: 700;
        }

        .widget-icon {
            font-size: 24px;
        }

        .widget-icon.premium-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .widget-icon.premium-icon svg {
            width: 100%;
            height: 100%;
            stroke: var(--accent-primary);
            filter: drop-shadow(0 2px 6px rgba(255, 107, 53, 0.3));
        }

        .widget-stats {
            display: flex;
            gap: 16px;
        }

        .widget-stat {
            flex: 1;
        }

        .widget-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .widget-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .coming-soon-badge {
            display: inline-block;
            background: var(--bg-elevated);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Check-in View */
        .checkin-content {
            padding: 20px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -0.8px;
        }

        .checkin-status {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .status-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .status-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .edit-btn {
            background: var(--accent-primary);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
        }

        .category-input {
            margin-bottom: 28px;
        }

        .category-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .input-category-name {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .input-category-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .input-category-icon svg {
            width: 18px;
            height: 18px;
        }

        .input-category-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .category-value-display {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-elevated);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.4);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            border: none;
        }

        .sleep-input {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 28px;
        }

        .sleep-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sleep-value-display {
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-primary);
            margin: 20px 0;
        }

        .sleep-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
        }

        .sleep-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
            transition: all 0.2s;
        }

        .sleep-btn:active {
            transform: scale(0.95);
        }

        .submit-btn {
            width: 100%;
            padding: 18px;
            background: var(--accent-primary);
            color: #000;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
            font-family: inherit;
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        /* Habit & Sober Tracker */
        .tracker-content {
            padding: 20px;
        }

        .coming-soon-screen {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 60px 24px;
            text-align: center;
        }

        .coming-soon-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .coming-soon-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .coming-soon-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Settings */
        .settings-content {
            padding: 20px;
        }

        .setting-item {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 16px;
        }

        .setting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .setting-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            display: block;
            min-height: 18px;
        }

        .setting-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 14px;
            line-height: 1.5;
            display: block;
            min-height: 16px;
        }

        .setting-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .setting-option {
            padding: 10px 18px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .setting-option.active {
            background: var(--accent-primary);
            color: #ffffff;
            border-color: var(--accent-primary);
        }

        /* Light Mode: Better contrast for active state */
        :root[data-theme="light"] .setting-option.active {
            background: #ff6b35;
            color: #ffffff;
        }

        .sleep-goal-input {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sleep-goal-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
        }

        .sleep-goal-value {
            flex: 1;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: var(--bg-elevated);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border);
        }

        .toggle-switch.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.2); /* Glow effect */
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: var(--bg-card);
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(22px);
        }
        
        /* Dark Mode: Black slider when active */
        :root[data-theme="dark"] .toggle-switch.active .toggle-slider {
            background: #000;
        }
        
        /* Light Mode: White slider when active */
        :root[data-theme="light"] .toggle-switch.active .toggle-slider {
            background: #ffffff;
        }

        /* Chart Details */
        .chart-details-view {
            padding: 20px;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 10px 0;
            margin-bottom: 20px;
            font-family: inherit;
        }

        /* Flatex-Style Stock List */
        .stock-list-container {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .stock-list-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stock-list-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .stock-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .stock-item:last-child {
            border-bottom: none;
        }

        .stock-item:active {
            background: var(--bg-elevated);
        }

        .stock-item-left {
            display: flex;
            align-items: center;
            gap: 14px;
            flex: 1;
        }

        .stock-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .stock-icon svg {
            width: 22px;
            height: 22px;
        }

        .stock-info {
            flex: 1;
        }

        .stock-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 3px;
            letter-spacing: -0.2px;
        }

        .stock-symbol {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stock-item-right {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
        }

        .stock-price {
            font-size: 17px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .stock-change {
            font-size: 13px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .stock-change.positive {
            background: rgba(0, 201, 109, 0.15);
            color: var(--accent-up);
        }

        .stock-change.negative {
            background: rgba(255, 51, 102, 0.15);
            color: var(--accent-down);
        }

        .stock-change.neutral {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .stock-arrow {
            font-size: 10px;
        }

        /* FYS Index Summary Card */
        .fys-index-summary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, #ff8f5f 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            color: #ffffff;
            box-shadow: 0 8px 24px rgba(255, 107, 53, 0.3);
        }

        .fys-index-label {
            font-size: 13px;
            font-weight: 600;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .fys-index-value {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: -2px;
            margin-bottom: 8px;
        }

        .fys-index-change {
            font-size: 16px;
            font-weight: 600;
            opacity: 0.95;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: -0.3px;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .single-chart-container {
            position: relative;
            height: 180px;
        }

        /* Category Detail Modal */
        .category-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 150;
            display: none;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .category-detail-modal.active {
            display: flex;
        }

        /* Journal Modal */
        .journal-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 150;
            display: none;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }

        .journal-modal.active {
            display: flex;
        }

        .journal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .journal-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .journal-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .journal-calendar {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-month {
            font-size: 18px;
            font-weight: 700;
        }

        .calendar-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-family: inherit;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            padding: 8px 0;
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg-elevated);
        }

        .calendar-day.empty {
            pointer-events: none;
            opacity: 0;
        }

        .calendar-day.today {
            background: var(--accent-primary);
            color: #000;
        }

        .calendar-day.has-entry::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--accent-primary);
        }

        .calendar-day.today.has-entry::after {
            background: #000;
        }

        .journal-entry-section {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 20px;
            display: none;
        }

        .journal-entry-section.active {
            display: block;
        }

        .journal-entry-date {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--accent-primary);
        }

        .journal-textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            line-height: 1.6;
            resize: vertical;
        }

        .journal-save-btn {
            width: 100%;
            padding: 14px;
            background: var(--accent-primary);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 12px;
            font-family: inherit;
        }

        .category-detail-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .category-detail-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-detail-icon svg {
            width: 26px;
            height: 26px;
        }

        .category-detail-info {
            flex: 1;
        }

        .category-detail-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .category-detail-symbol {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .category-detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .category-detail-price-section {
            margin-bottom: 24px;
        }

        .category-detail-price {
            font-size: 42px;
            font-weight: 800;
            letter-spacing: -1.5px;
            margin-bottom: 8px;
        }

        .category-detail-change {
            font-size: 16px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .category-time-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .category-time-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            font-family: inherit;
        }

        .category-time-btn.active {
            background: var(--accent-primary);
            color: #000;
            border-color: var(--accent-primary);
        }

        .category-chart-card {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 20px;
        }

        .category-chart-container {
            position: relative;
            height: 280px;
        }

        .coach-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 80px; /* Platz für Bottom Nav */
            background: var(--bg-primary);
            z-index: 250; /* Unter Bottom Nav */
            display: none;
            flex-direction: column;
        }

        .coach-modal.active {
            display: flex;
        }

        .coach-header {
            padding: 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .coach-title {
            font-size: 18px;
            font-weight: 700;
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-family: inherit;
        }

        .coach-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
            animation: messageIn 0.3s ease;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 80%;
            padding: 14px 18px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary); /* Einheitliche Farbe */
        }

        .message.assistant .message-bubble {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary); /* Explizit */
        }

        .message.user .message-bubble {
            background: var(--accent-primary);
            color: #ffffff; /* Weiß auf Orange */
            font-weight: 500;
        }

        .coach-input-area {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .coach-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .coach-input {
            flex: 1;
            padding: 14px 18px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .send-btn {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            background: var(--accent-primary);
            border: none;
            color: #000;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
        }

        .send-btn:disabled {
            opacity: 0.4;
        }

        /* Bottom Navigation - Pushup App Style (Floating Pill) */
        .bottom-nav {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 560px;
            width: calc(100% - 40px);
            height: 68px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 20px;
            z-index: 200;
            
            /* Glassmorphism Effect */
            background: rgba(28, 28, 30, 0.78);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            
            /* Floating Pill Shape */
            border-radius: 34px;
            border: 0.5px solid rgba(255, 255, 255, 0.18);
            
            /* Subtle Shadow */
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        [data-theme="light"] .bottom-nav {
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 0.5px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.95);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 14px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-family: inherit;
            position: relative;
            flex: 1;
            max-width: 80px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 16px;
        }

        /* Inaktive Tabs */
        .nav-item {
            color: rgba(235, 235, 245, 0.6);
        }

        [data-theme="light"] .nav-item {
            color: rgba(60, 60, 67, 0.6);
        }

        /* Aktiver Tab - Orange */
        .nav-item.active {
            color: #ff6b35;
            transform: scale(1.05);
        }

        [data-theme="light"] .nav-item.active {
            color: #ff6b35;
        }

        /* Pop Animation beim Aktivieren */
        @keyframes tabPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.12); }
            100% { transform: scale(1.05); }
        }

        .nav-item.active {
            animation: tabPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Hover State */
        .nav-item:hover:not(.active) {
            color: rgba(235, 235, 245, 0.85);
            transform: scale(1.02);
        }

        [data-theme="light"] .nav-item:hover:not(.active) {
            color: rgba(60, 60, 67, 0.85);
        }

        /* Active Press State */
        .nav-item:active {
            transform: scale(0.95);
        }

        .nav-icon {
            width: 26px;
            height: 26px;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.8; /* Dünner */
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Aktives Icon - stärker */
        .nav-item.active .nav-icon {
            stroke-width: 2.2; /* Dünner */
            filter: drop-shadow(0 2px 6px rgba(255, 107, 53, 0.4));
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: -0.2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Aktives Label - stärker */
        .nav-item.active .nav-label {
            font-weight: 700;
            letter-spacing: -0.1px;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .success-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--accent-primary);
            color: #000;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            z-index: 400;
            opacity: 0;
            transition: all 0.3s;
        }

        .success-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid var(--bg-elevated);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* ========================================
           WIZARD CHECK-IN STYLES
           ======================================== */
        
        /* Confirmation Dialog */
        .wizard-confirm {
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 200px);
            padding: 40px 24px;
        }
        
        .wizard-confirm.active {
            display: flex; /* Show when active */
        }
        
        /* Error Fallback UI */
        .wizard-error {
            display: none;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 200px);
            padding: 40px 24px;
        }
        
        .wizard-error.active {
            display: flex;
        }
        
        .error-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }
        
        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .error-title {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .error-message {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 28px;
            line-height: 1.5;
        }
        
        .error-retry-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ff6b35, #ff8f5f);
            border: none;
            border-radius: 16px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .error-retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 107, 53, 0.4);
        }

        .confirm-content {
            text-align: center;
            max-width: 400px;
        }

        .confirm-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .confirm-title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .confirm-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
        }

        .btn-secondary {
            flex: 1;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .btn-primary-wizard {
            flex: 1;
            padding: 16px;
            background: linear-gradient(135deg, #ff6b35, #ff8f5f);
            border: none;
            border-radius: 16px;
            color: #ffffff; /* Default: white text */
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        /* Dark Mode: Black text on orange buttons */
        :root[data-theme="dark"] .btn-primary-wizard,
        :root[data-theme="dark"] .btn-primary {
            color: #000000;
        }
        
        /* Light Mode: White text on orange buttons */
        :root[data-theme="light"] .btn-primary-wizard,
        :root[data-theme="light"] .btn-primary {
            color: #ffffff;
        }

        .btn-primary-wizard:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.3);
        }

        /* Wizard Container */
        .wizard-container {
            display: none; /* Initially hidden */
            flex-direction: column;
            height: calc(100vh - 80px); /* Space for bottom nav */
            position: relative;
        }
        
        .wizard-container.active {
            display: flex; /* Show when active */
        }

        .wizard-header {
            padding: 20px 24px 16px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0; /* Don't shrink */
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .back-btn-wizard {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            color: var(--accent-primary);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 20px;
        }

        .back-btn-wizard:hover {
            background: rgba(255, 107, 53, 0.2);
        }

        .back-btn-wizard:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .close-btn-wizard {
            background: none;
            border: none;
            color: #666;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
        }

        .step-counter {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .progress-container-wizard {
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar-wizard {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #ff8f5f);
            transition: width 0.3s ease;
            width: 12.5%;
        }

        .progress-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
            transition: all 0.3s;
        }

        .dot.active {
            background: var(--accent-primary);
            width: 24px;
            border-radius: 4px;
        }

        .dot.completed {
            background: var(--accent-primary);
        }

        /* Content Area */
        .wizard-content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
            min-height: 0; /* Important for flex children */
        }

        .step-container-wizard {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none; /* Hide by default */
            flex-direction: column;
            padding: 20px 24px 140px; /* Extra bottom padding to clear button area */
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto; /* Allow scrolling if needed */
            pointer-events: none; /* Disable interaction when not active */
        }

        .step-container-wizard.active {
            display: flex; /* Show active step */
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto; /* Enable interaction */
        }

        .step-container-wizard.prev {
            display: none; /* Completely hide previous steps */
            transform: translateX(-100%);
            pointer-events: none;
        }

        .category-icon-wizard {
            width: 64px;
            height: 64px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .category-icon-wizard svg {
            width: 32px;
            height: 32px;
        }

        .step-title-wizard {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .step-subtitle-wizard {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .input-area-wizard {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-top: 40px;
        }

        .slider-value-display-wizard {
            text-align: center;
            margin-bottom: 40px;
        }

        .slider-value-wizard {
            font-size: 72px;
            font-weight: 900;
            background: linear-gradient(135deg, #ff6b35, #ff8f5f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -2px;
        }

        .slider-label-wizard {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }

        .slider-wizard {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-secondary);
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 20px;
        }

        .slider-wizard::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35, #ff8f5f);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .slider-wizard::-moz-range-thumb {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35, #ff8f5f);
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .slider-labels-wizard {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            padding: 0 4px;
        }

        /* Review Screen */
        .review-list-wizard {
            flex: 1;
            overflow-y: auto;
            margin-top: 24px;
        }

        .review-item-wizard {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .review-item-wizard:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #333;
        }

        .review-item-left-wizard {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .review-icon-wizard {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .review-icon-wizard svg {
            width: 20px;
            height: 20px;
        }

        .review-info-wizard {
            display: flex;
            flex-direction: column;
        }

        .review-category-wizard {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .review-hint-wizard {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .review-value-wizard {
            font-size: 24px;
            font-weight: 800;
            color: var(--accent-primary);
        }

        .wizard-actions {
            padding: 20px 24px calc(80px + 20px); /* Bottom nav height + padding */
            background: var(--bg-elevated);
            border-top: 1px solid var(--border);
            flex-shrink: 0; /* Don't shrink */
            position: relative;
            z-index: 10;
        }

        /* ========================================
           PERFORMANCE PACKS STYLES
           ======================================== */
        
        .performance-packs-container {
            margin-top: 24px;
        }

        .performance-packs-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-tertiary);
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .performance-pack-card {
            background: var(--bg-card);
            border-radius: 20px;
            border: 2px solid var(--border);
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .performance-pack-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent, rgba(255, 107, 53, 0.05));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .performance-pack-card:hover::before {
            opacity: 1;
        }

        .performance-pack-card.active {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.05), transparent);
        }

        .performance-pack-card:active {
            transform: scale(0.98);
        }

        .pack-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .pack-info-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pack-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(255, 107, 53, 0.1);
            flex-shrink: 0;
        }

        .pack-name-info {
            display: flex;
            flex-direction: column;
        }

        .pack-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .pack-index-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .pack-toggle {
            width: 50px;
            height: 28px;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .pack-toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--text-secondary);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .pack-toggle.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .pack-toggle.active::after {
            left: 24px;
            background: #000;
        }

        .pack-description {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .pack-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            position: relative;
            z-index: 1;
        }

        .pack-category-chip {
            padding: 4px 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .performance-pack-card.active .pack-category-chip {
            background: rgba(255, 107, 53, 0.1);
            border-color: rgba(255, 107, 53, 0.3);
            color: var(--accent-primary);
        }

        .performance-pack-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .performance-pack-card.locked .pack-toggle {
            opacity: 0.5;
            pointer-events: none;
        }

        .lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            z-index: 10;
        }

        .lock-icon {
            font-size: 36px;
            color: var(--text-secondary);
        }
        /* ============================================ */
        /* TYPOGRAPHY - THINNER WEIGHTS */
        /* ============================================ */
        :root {
            --font-weight-light: 300;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
        }

        body {
            font-weight: var(--font-weight-light); /* 400 → 300 */
        }

        h1, h2, h3, .section-title {
            font-weight: var(--font-weight-medium); /* 600 → 500 */
        }

        button, .btn-primary, .btn-secondary, .nav-label {
            font-weight: var(--font-weight-normal); /* 500 → 400 */
        }

        /* Keep bold for numbers */
        .index-value-number, .category-detail-price, .stock-price {
            font-weight: var(--font-weight-bold);
        }

        /* ============================================ */
        /* FLOATING CHECK-IN BUTTON */
        /* ============================================ */
        /* ============================================ */
        /* TOOLS VIEW */
        /* ============================================ */
        .tool-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tool-card:hover {
            background: var(--bg-elevated);
            transform: translateX(4px);
        }

        .tool-icon {
            font-size: 32px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
            border-radius: 12px;
        }

        .tool-info {
            flex: 1;
        }

        .tool-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .tool-description {
            font-size: 13px;
            font-weight: 300;
            color: var(--text-secondary);
        }

        .pro-badge-small {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
        }

        /* ============================================ */
        /* UPGRADE MODAL */
        /* ============================================ */
        .upgrade-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .upgrade-modal.active {
            display: flex;
        }

        .upgrade-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 32px;
            max-width: 400px;
            text-align: center;
            position: relative;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upgrade-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .upgrade-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .upgrade-description {
            font-size: 14px;
            font-weight: 300;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .upgrade-features {
            text-align: left;
            margin-bottom: 24px;
        }

        .upgrade-feature {
            padding: 8px 0;
            font-size: 14px;
            font-weight: 400;
            color: var(--text-primary);
        }

        .upgrade-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ff6b35, #ff8f5f);
            border: none;
            border-radius: 12px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 107, 53, 0.4);
        }

        /* ============================================ */
        /* DAILY CHECK-IN WIDGET */
        /* ============================================ */
        .checkin-widget {
            position: sticky; /* Sticky on scroll */
            top: 0; /* Stick to top */
            z-index: 50; /* Above content, below modals */
            
            background: rgba(255, 107, 53, 0.95); /* Semi-transparent for glass effect */
            backdrop-filter: blur(20px) saturate(180%); /* Glassmorphism */
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0 16px 0; /* Top margin for breathing room */
            cursor: pointer;
            
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2),
                        0 8px 24px rgba(255, 107, 53, 0.1);
            
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .checkin-widget:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 107, 53, 0.3),
                        0 12px 36px rgba(255, 107, 53, 0.15);
        }
        
        /* Compact mode when sticky (smaller) */
        .checkin-widget.is-sticky {
            padding: 14px 18px; /* Slightly bigger for better look */
            margin: 0; /* No margin when sticky */
            border-radius: 16px; /* Fully rounded, not cut off */
            box-shadow: 0 8px 24px rgba(255, 107, 53, 0.35),
                        0 16px 48px rgba(255, 107, 53, 0.2);
            backdrop-filter: blur(30px) saturate(200%);
            -webkit-backdrop-filter: blur(30px) saturate(200%);
        }
        
        /* Hide subtitle when sticky */
        .checkin-widget.is-sticky .checkin-widget-subtitle {
            display: none;
        }
        
        /* Smaller icon when sticky */
        .checkin-widget.is-sticky .checkin-widget-icon {
            width: 40px; /* Slightly bigger: 36 → 40 */
            height: 40px;
        }
        
        .checkin-widget.is-sticky .checkin-widget-icon svg {
            width: 20px; /* Slightly bigger: 18 → 20 */
            height: 20px;
        }
        
        /* Smaller title when sticky */
        .checkin-widget.is-sticky .checkin-widget-title {
            font-size: 16px; /* Slightly bigger: 15 → 16 */
        }

        .checkin-widget-header {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .checkin-widget-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkin-widget-icon svg {
            width: 24px;
            height: 24px;
            stroke: #ffffff;
        }

        .checkin-widget-info {
            flex: 1;
        }

        .checkin-widget-title {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .checkin-widget-subtitle {
            font-size: 13px;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
        }

        .checkin-widget-arrow {
            font-size: 24px;
            color: #ffffff;
            opacity: 0.8;
        }

        /* ============================================ */
        /* ACTIVE PERFORMANCE PACK CARD */
        /* ============================================ */
        /* ============================================ */
        /* ENHANCED CATEGORY DETAILS */
        /* ============================================ */
        .category-influence-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .influence-title {
            font-size: 12px;
            font-weight: 300;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .influence-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 4px;
        }

        .influence-description {
            font-size: 11px;
            font-weight: 300;
            color: var(--text-secondary);
        }

        .trend-badge {
            font-size: 10px;
            font-weight: 400;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .trend-badge.bullish {
            background: rgba(0, 255, 136, 0.1);
            color: var(--accent-up);
        }

        .trend-badge.bearish {
            background: rgba(255, 51, 102, 0.1);
            color: var(--accent-down);
        }

        .trend-badge.neutral {
            background: rgba(128, 128, 128, 0.1);
            color: var(--text-secondary);
        }

        .recent-checkins-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .checkins-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .checkin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .checkin-item:last-child {
            border-bottom: none;
        }

        .checkin-date {
            font-size: 12px;
            font-weight: 300;
            color: var(--text-secondary);
        }

        .checkin-rating {
            font-size: 10px;
        }

        .checkin-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ============================================ */
        /* WIZARD SUMMARY */
        /* ============================================ */
        .summary-container {
            padding: 20px;
        }

        .summary-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .summary-subtitle {
            font-size: 14px;
            font-weight: 300;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .summary-list {
            margin-bottom: 24px;
        }

        .summary-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .summary-item:hover {
            background: var(--bg-elevated);
            transform: translateX(4px);
        }

        .summary-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .summary-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        .summary-icon svg {
            width: 20px;
            height: 20px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .summary-actions button {
            flex: 1;
        }

        /* ============================================ */
        /* LIGHT MODE BUTTON CONTRAST FIX */
        /* ============================================ */
        :root[data-theme="light"] .btn-primary,
        :root[data-theme="light"] .btn-primary-wizard,
        :root[data-theme="light"] .floating-checkin-btn,
        :root[data-theme="light"] .upgrade-btn {
            background: linear-gradient(135deg, #ff6b35, #ff8f5f);
            color: #ffffff !important;
            border: none;
        }

        :root[data-theme="light"] button:not(.nav-item) {
            color: var(--text-primary);
        }

        :root[data-theme="light"] .btn-primary,
        :root[data-theme="light"] .btn-primary-wizard {
            color: #ffffff !important;
        }

    </style>
</head>
<body>
    <!-- Premium Loading Screen - Bitpanda Style -->
    <div id="loadingScreen">
        <div class="loading-logo-container">
            <!-- FYS Logo - EXACT 1:1 from uploaded image -->
            <svg viewBox="0 0 240 120" class="loading-logo">
                <path d="M 20 20 L 20 100 M 20 20 L 60 20 M 20 60 L 50 60" stroke="url(#gradientLoading)" stroke-width="8" stroke-linecap="round" fill="none"/>
                <path d="M 80 20 L 100 60 L 100 100 M 120 20 L 100 60" stroke="url(#gradientLoading)" stroke-width="8" stroke-linecap="round" fill="none"/>
                <path d="M 100 85 L 100 45 L 95 50 M 100 45 L 105 50" stroke="#ff8f5f" stroke-width="4" stroke-linecap="round" fill="none" style="transform-origin: 100px 65px;"/>
                <path d="M 170 30 Q 150 20, 140 30 T 150 50 Q 160 60, 170 70 Q 180 80, 170 90 Q 160 100, 140 90" stroke="url(#gradientLoading)" stroke-width="8" stroke-linecap="round" fill="none"/>
                <defs>
                    <linearGradient id="gradientLoading" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#ff6b35;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ffb088;stop-opacity:1" />
                    </linearGradient>
                </defs>
            </svg>
        </div>
    </div>

<div class="app-container">
        <!-- Header with Logo -->
        <div class="header">
            <div class="logo-fys-header">
                <!-- FYS Logo SVG - Professionell -->
                <svg viewBox="0 0 120 60" class="fys-logo-svg">
                    <!-- F -->
                    <path d="M 10 10 L 10 50 M 10 10 L 30 10 M 10 30 L 25 30" 
                          stroke="#ff6b35" stroke-width="4" stroke-linecap="round" fill="none"/>
                    
                    <!-- Y mit Pfeil -->
                    <path d="M 40 10 L 50 30 L 50 50 M 60 10 L 50 30" 
                          stroke="#ff6b35" stroke-width="4" stroke-linecap="round" fill="none"/>
                    
                    <!-- Pfeil im Y -->
                    <g class="arrow-animated">
                        <path d="M 50 45 L 50 20" 
                              stroke="#ff8f5f" stroke-width="3" stroke-linecap="round" 
                              stroke-dasharray="30" stroke-dashoffset="30" fill="none"/>
                        <polyline points="45,25 50,20 55,25" 
                                  stroke="#ff8f5f" stroke-width="3" stroke-linecap="round" 
                                  fill="none" opacity="0"/>
                    </g>
                    
                    <!-- S -->
                    <path d="M 85 15 Q 75 10, 70 15 T 75 25 Q 80 30, 85 35 Q 90 40, 85 45 Q 80 50, 70 45" 
                          stroke="#ff6b35" stroke-width="4" stroke-linecap="round" fill="none"/>
                </svg>
            </div>
            <div class="header-date" id="headerDate"></div>
        </div>

        <!-- Home View -->
        <div id="homeView" class="view-section active">
            <div class="home-content">
                <div class="index-label">FYS-INDEX</div>
                
                <!-- Daily Check-in Widget (MOVED TO TOP) -->
                <div class="checkin-widget" onclick="switchView('checkin')">
                    <div class="checkin-widget-header">
                        <div class="checkin-widget-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        <div class="checkin-widget-info">
                            <div class="checkin-widget-title">Daily Check-In</div>
                            <div class="checkin-widget-subtitle" id="checkinWidgetSubtitle">Beantworte 8 Fragen zu deinem Tag</div>
                        </div>
                        <div class="checkin-widget-arrow">→</div>
                    </div>
                </div>
                
                <div class="time-selector">
                    <button class="time-btn" onclick="changeTimeRange('1d')" data-range="1d">1D</button>
                    <button class="time-btn" onclick="changeTimeRange('7d')" data-range="7d">7D</button>
                    <button class="time-btn active" onclick="changeTimeRange('1m')" data-range="1m">1M</button>
                    <button class="time-btn" onclick="changeTimeRange('6m')" data-range="6m">6M</button>
                    <button class="time-btn" onclick="changeTimeRange('1y')" data-range="1y">1Y</button>
                    <button class="time-btn" onclick="changeTimeRange('all')" data-range="all">MAX</button>
                </div>

                <div class="main-chart-section" onclick="openChartDetails()">
                    <div class="main-chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                    <div class="index-value-display">
                        <div class="index-value-number" id="mainIndexValue">100.0</div>
                        <div class="index-change-text" id="mainChangeText"></div>
                    </div>
                    <div class="tap-hint" id="tapHint"></div>
                </div>

                <!-- Performance Packs Section -->
                <div class="performance-packs-container" id="performancePacksContainer" style="display: none;">
                    <div class="performance-packs-title">
                        📊 PERFORMANCE PACKS
                        <span style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 800;">PRO</span>
                    </div>
                    <div id="performancePacksList"></div>
                </div>

            </div>
        </div>

        <!-- Chart Details View -->
        <div id="chartDetailsView" class="view-section">
            <div class="chart-details-view">
                <button class="back-button" onclick="closeChartDetails()">
                    ← <span id="backText">Zurück</span>
                </button>
                
                <!-- FYS Index Summary -->
                <div class="fys-index-summary">
                    <div class="fys-index-label">FYS-INDEX</div>
                    <div class="fys-index-value" id="detailIndexValue">100.0</div>
                    <div class="fys-index-change" id="detailIndexChange">+0.00%</div>
                </div>

                <!-- Flatex-Style Stock List -->
                <div class="stock-list-container">
                    <div class="stock-list-header">
                        <div class="stock-list-title" id="categoriesOverview">Kategorien-Übersicht</div>
                    </div>
                    <div id="stockListItems"></div>
                </div>

                <!-- Combined Chart -->
                <div class="chart-card">
                    <div class="chart-title" id="allCategoriesTitle">Alle Kategorien</div>
                    <div class="chart-container">
                        <canvas id="combinedChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Check-in View mit Wizard -->
        <div id="checkinView" class="view-section">
            <!-- Confirmation Dialog -->
            <div class="wizard-confirm" id="wizardConfirm">
                <div class="confirm-content">
                    <div class="confirm-icon">📝</div>
                    <div class="confirm-title">Check-in für heute starten?</div>
                    <div class="confirm-subtitle" id="wizardConfirmSubtitle">Beantworte 8 kurze Fragen zu deinem Tag</div>
                    <div class="confirm-actions">
                        <button class="btn-secondary" onclick="cancelWizard()">Abbrechen</button>
                        <button class="btn-primary-wizard" onclick="startWizard()">Starten</button>
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div class="wizard-error" id="wizardError">
                <div class="error-card">
                    <div class="error-icon">⚠️</div>
                    <div class="error-title">Check-in konnte nicht geladen werden</div>
                    <div class="error-message">Es gab ein Problem beim Laden der Fragen. Bitte versuche es erneut.</div>
                    <button class="error-retry-btn" onclick="retryWizard()">
                        Erneut versuchen
                    </button>
                </div>
            </div>

            <!-- Wizard Container -->
            <div class="wizard-container" id="wizardContainer">
                <!-- Header -->
                <div class="wizard-header">
                    <div class="header-top">
                        <button class="back-btn-wizard" id="backBtnWizard" disabled>←</button>
                        <div class="step-counter" id="stepCounter">Schritt 1/8</div>
                        <button class="close-btn-wizard" onclick="closeWizard()">×</button>
                    </div>
                    <div class="progress-container-wizard">
                        <div class="progress-bar-wizard" id="progressBarWizard"></div>
                    </div>
                    <div class="progress-dots" id="progressDots"></div>
                </div>

                <!-- Content -->
                <div class="wizard-content-area" id="wizardContent"></div>

                <!-- Actions -->
                <div class="wizard-actions">
                    <button class="btn-primary-wizard" id="nextBtnWizard">Weiter</button>
                </div>
            </div>
        </div>

        <!-- Habit Tracker View -->
        <div id="habitsView" class="view-section">
            <div class="tracker-content">
                <div class="section-title" id="habitsTitle"></div>
                <div class="coming-soon-screen">
                    <div class="coming-soon-icon">🎯</div>
                    <div class="coming-soon-title" id="habitComingTitle"></div>
                    <div class="coming-soon-text" id="habitComingText"></div>
                </div>
            </div>
        </div>

        <!-- Sober Tracker View -->
        <div id="soberView" class="view-section">
            <div class="tracker-content">
                <div class="section-title" id="soberTitle"></div>
                <div class="coming-soon-screen">
                    <div class="coming-soon-icon">🌟</div>
                    <div class="coming-soon-title" id="soberComingTitle"></div>
                    <div class="coming-soon-text" id="soberComingText"></div>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settingsView" class="view-section">
            <div class="settings-content">
                <div class="section-title" id="settingsTitle"></div>
                
                <div class="setting-item">
                    <div class="setting-label" id="languageLabel"></div>
                    <div class="setting-description" id="languageDesc"></div>
                    <div class="setting-options">
                        <div class="setting-option active" onclick="changeLanguage('de')" data-lang="de">Deutsch</div>
                        <div class="setting-option" onclick="changeLanguage('en')" data-lang="en">English</div>
                        <div class="setting-option" onclick="changeLanguage('es')" data-lang="es">Español</div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label" id="themeLabel"></div>
                    <div class="setting-description" id="themeDesc"></div>
                    <div class="setting-options">
                        <div class="setting-option active" onclick="changeTheme('dark')" data-theme-btn="dark" id="darkTheme"></div>
                        <div class="setting-option" onclick="changeTheme('light')" data-theme-btn="light" id="lightTheme"></div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label" id="sleepGoalLabel"></div>
                    <div class="setting-description" id="sleepGoalDesc"></div>
                    <div class="sleep-goal-input">
                        <button class="sleep-goal-btn" onclick="adjustSleepGoal(-0.5)">−</button>
                        <div class="sleep-goal-value" id="sleepGoalValue">8.0h</div>
                        <button class="sleep-goal-btn" onclick="adjustSleepGoal(0.5)">+</button>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label" id="coachDataLabel"></div>
                    <div class="setting-description" id="coachDataDesc"></div>
                    <div style="display: flex; justify-content: center; margin-top: 14px;">
                        <div class="toggle-switch" id="coachDataToggle" onclick="toggleCoachData()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <!-- Pro Toggle -->
                <div class="setting-item" style="text-align: center;">
                    <div class="setting-label">🌟 FYS Pro</div>
                    <div class="setting-description" id="proStatusDesc">Performance Packs & Advanced Features</div>
                    <button onclick="togglePro()" id="proToggleBtn" style="
                        width: 100%;
                        margin-top: 16px;
                        padding: 14px;
                        background: linear-gradient(135deg, #ff6b35, #ff8f5f);
                        border: none;
                        border-radius: 12px;
                        color: #000;
                        font-size: 15px;
                        font-weight: 700;
                        cursor: pointer;
                        font-family: inherit;
                        transition: all 0.3s;
                    ">Activate FYS Pro</button>
                </div>

                <!-- Performance Packs Management -->
                <div id="performancePacksSettings" style="display: none;">
                    <div class="setting-item">
                        <div class="setting-label">📊 Performance Packs</div>
                        <div class="setting-description">Wähle bis zu 2 Packs aus (aktiv: <span id="activePacksCount">0</span>/2)</div>
                    </div>

                    <div id="packSettingsList"></div>
                </div>
            </div>
        </div>

        <!-- Tools View (NEW) -->
        <div id="toolsView" class="view-section">
            <div class="content-container">
                <div class="section-title">🛠️ Tools & Features</div>
                
                <!-- Performance Report -->
                <div class="tool-card" onclick="openPerformanceReport()">
                    <div class="tool-icon">📊</div>
                    <div class="tool-info">
                        <div class="tool-title">Performance Report</div>
                        <div class="tool-description">Export detailed PDF report</div>
                    </div>
                    <div class="pro-badge-small">PRO</div>
                </div>
                
                <!-- Tagebuch (Journal) -->
                <div class="tool-card" onclick="openJournal()">
                    <div class="tool-icon">📔</div>
                    <div class="tool-info">
                        <div class="tool-title">Tagebuch</div>
                        <div class="tool-description">Dokumentiere deine Gedanken</div>
                    </div>
                    <div class="pro-badge-small">PRO</div>
                </div>
                
                <!-- Task Manager -->
                <div class="tool-card" onclick="openTaskManager()">
                    <div class="tool-icon">✓</div>
                    <div class="tool-info">
                        <div class="tool-title">Task Manager</div>
                        <div class="tool-description">Verwalte deine Aufgaben</div>
                    </div>
                </div>
                
                <!-- Habit Tracker -->
                <div class="tool-card" onclick="openHabitTracker()">
                    <div class="tool-icon">🎯</div>
                    <div class="tool-info">
                        <div class="tool-title">Habit Tracker</div>
                        <div class="tool-description">Tracke deine Gewohnheiten</div>
                    </div>
                </div>
                
                <!-- Sober Tracker -->
                <div class="tool-card" onclick="openSoberTracker()">
                    <div class="tool-icon">🌟</div>
                    <div class="tool-info">
                        <div class="tool-title">Sober Tracker</div>
                        <div class="tool-description">Verfolge deine Erfolge</div>
                    </div>
                </div>
                
                <!-- Data & Statistics -->
                <div class="tool-card" onclick="openStatistics()">
                    <div class="tool-icon">📈</div>
                    <div class="tool-info">
                        <div class="tool-title">Data & Statistics</div>
                        <div class="tool-description">Detailed analytics dashboard</div>
                    </div>
                </div>
                
                <!-- Pro Features Overview -->
                <div class="tool-card" onclick="openProFeatures()">
                    <div class="tool-icon">⭐</div>
                    <div class="tool-info">
                        <div class="tool-title">Pro Features</div>
                        <div class="tool-description">View all premium features</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="success-toast" id="successToast"></div>
    </div>

    <!-- Upgrade Modal (NEW) -->
    <div class="upgrade-modal" id="upgradeModal">
        <div class="upgrade-content">
            <button class="close-btn" onclick="closeUpgradeModal()">×</button>
            <div class="upgrade-icon">⭐</div>
            <div class="upgrade-title">Upgrade to FYS Pro</div>
            <div class="upgrade-description">
                Unlock Performance Packs, PDF Reports, and Advanced Analytics
            </div>
            <div class="upgrade-features">
                <div class="upgrade-feature">✓ 3 Performance Packs</div>
                <div class="upgrade-feature">✓ PDF Export</div>
                <div class="upgrade-feature">✓ Advanced Statistics</div>
                <div class="upgrade-feature">✓ Unlimited History</div>
            </div>
            <button class="upgrade-btn" onclick="activateProFromModal()">
                Activate Pro Now
            </button>
        </div>
    </div>

    <!-- Bottom Navigation - Pushup Style (Floating Pill) -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchView('home')" data-view="home">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <div class="nav-label" id="navHome">Start</div>
        </button>
        <button class="nav-item" onclick="switchView('tools')" data-view="tools">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
            </svg>
            <div class="nav-label" id="navTools">Tools</div>
        </button>
        <button class="nav-item" onclick="switchToCoach()" data-view="coach">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <div class="nav-label" id="navCoach">Coach</div>
        </button>
        <button class="nav-item" onclick="switchView('settings')" data-view="settings">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6M12 17v6M3.93 3.93l4.24 4.24M15.83 15.83l4.24 4.24M1 12h6M17 12h6M3.93 20.07l4.24-4.24M15.83 8.17l4.24-4.24"></path>
            </svg>
            <div class="nav-label" id="navSettings">Einstellungen</div>
        </button>
    </div>

    <!-- Floating Check-in Button (Apple Trading Style) -->
    <!-- AI Coach Modal -->
    <div class="coach-modal" id="coachModal">
        <div class="coach-header">
            <div class="coach-title" id="coachTitle"></div>
            <button class="close-btn" onclick="closeCoach()">×</button>
        </div>
        <div class="coach-content" id="coachContent"></div>
        <div class="coach-input-area">
            <div class="coach-input-wrapper">
                <input type="text" class="coach-input" id="coachInput" onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="send-btn" onclick="sendMessage()" id="sendBtn">➤</button>
            </div>
        </div>
    </div>

    <!-- Category Detail Modal -->
    <div class="category-detail-modal" id="categoryDetailModal">
        <div class="category-detail-header">
            <button class="close-btn" onclick="closeCategoryDetail()">×</button>
            <div class="category-detail-icon" id="categoryDetailIcon"></div>
            <div class="category-detail-info">
                <div class="category-detail-name" id="categoryDetailName"></div>
                <div class="category-detail-symbol" id="categoryDetailSymbol"></div>
            </div>
        </div>
        <div class="category-detail-content">
            <div class="category-detail-price-section">
                <div class="category-detail-price" id="categoryDetailPrice">100.0</div>
                <div class="category-detail-change positive" id="categoryDetailChange">
                    <span>▲</span> +0.0%
                </div>
            </div>

            <div class="category-time-selector">
                <button class="category-time-btn" onclick="changeCategoryTimeRange('1d')" data-cat-range="1d">1D</button>
                <button class="category-time-btn" onclick="changeCategoryTimeRange('7d')" data-cat-range="7d">7D</button>
                <button class="category-time-btn active" onclick="changeCategoryTimeRange('1m')" data-cat-range="1m">1M</button>
                <button class="category-time-btn" onclick="changeCategoryTimeRange('6m')" data-cat-range="6m">6M</button>
                <button class="category-time-btn" onclick="changeCategoryTimeRange('1y')" data-cat-range="1y">1Y</button>
                <button class="category-time-btn" onclick="changeCategoryTimeRange('all')" data-cat-range="all">MAX</button>
            </div>

            <div class="category-chart-card">
                <div class="category-chart-container">
                    <canvas id="categoryDetailChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Journal Modal -->
    <div class="journal-modal" id="journalModal">
        <div class="journal-header">
            <div class="journal-title">📔 Tagebuch</div>
            <button class="close-btn" onclick="closeJournal()">×</button>
        </div>
        <div class="journal-content">
            <div class="journal-calendar">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="changeMonth(-1)">‹</button>
                    <div class="calendar-month" id="calendarMonth"></div>
                    <button class="calendar-nav-btn" onclick="changeMonth(1)">›</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
            <div class="journal-entry-section" id="journalEntrySection">
                <div class="journal-entry-date" id="journalEntryDate"></div>
                <textarea class="journal-textarea" id="journalTextarea" placeholder="Schreibe deine Gedanken..."></textarea>
                <button class="journal-save-btn" onclick="saveJournalEntry()">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SAFE DOM HELPERS (Prevents null errors)
        // ============================================
        function safeSetHTML(selector, html) {
            const el = typeof selector === 'string' ? document.querySelector(selector) : selector;
            if (!el) {
                console.warn(`[SafeHTML] Element not found:`, selector);
                return false;
            }
            el.innerHTML = html;
            return true;
        }

        function safeGetElement(id) {
            const el = document.getElementById(id);
            if (!el) console.warn(`[SafeDOM] Element not found: #${id}`);
            return el;
        }

        // ============================================
        // TRANSLATIONS
        // ============================================
        // Translations
        const translations = {
            de: {
                headerDate: '',
                tapHint: 'Tippen für Details',
                backText: 'Zurück',
                allCategoriesTitle: 'Alle Kategorien',
                categoriesOverview: 'Kategorien-Übersicht',
                checkinTitle: 'Täglicher Check-in',
                checkinDone: 'Check-in für',
                checkinDoneText: 'bereits erledigt! Du kannst deine Kursänderung schon ansehen.',
                checkinDoneSub: 'Wir sehen uns morgen wieder! 🚀',
                editCheckin: 'Ändern',
                sleepQuestion: 'Wie viele Stunden hast du geschlafen?',
                taskWidgetTitle: 'Task Manager',
                comingSoonBadge: 'Bald verfügbar',
                habitsTitle: 'Habit Tracker',
                soberTitle: 'Sober Tracker',
                habitWidgetTitle: 'Habit Tracker',
                habitStreakLabel: 'Streak',
                habitTodayLabel: 'Heute',
                soberWidgetTitle: 'Sober Tracker',
                soberDaysLabel: 'Tage',
                soberStreakLabel: 'Streak',
                habitComingTitle: 'Bald verfügbar',
                habitComingText: 'Der Habit Tracker wird in Kürze freigeschaltet.',
                soberComingTitle: 'Bald verfügbar',
                soberComingText: 'Der Sober Tracker wird in Kürze freigeschaltet.',
                settingsTitle: 'Einstellungen',
                languageLabel: 'Sprache',
                languageDesc: 'Wähle deine bevorzugte App-Sprache.',
                themeLabel: 'Design',
                themeDesc: 'Wähle zwischen hellem und dunklem Modus.',
                darkTheme: 'Dunkel',
                lightTheme: 'Hell',
                sleepGoalLabel: 'Schlafziel',
                sleepGoalDesc: 'Dein ideales Schlafziel pro Nacht. Beeinflusst deine Energie-Kategorie.',
                coachDataLabel: 'KI-Coach Datenzugriff',
                coachDataDesc: 'Erlaube dem Coach deine Werte zu sehen.',
                navHome: 'Start',
                navCheckin: 'Check-in',
                navCoach: 'Coach',
                navSettings: 'Einstellungen',
                coachTitle: 'FYS Coach',
                coachPlaceholder: 'Stelle eine Frage...',
                coachWelcome: 'Hey! 👋 Wie kann ich dir helfen?',
                submitBtn: 'Speichern',
                successToast: '✓ Gespeichert!',
                categories: {
                    social: 'Soziale Kontakte',
                    energy: 'Energie/Erholung',
                    focus: 'Fokus/Produktivität',
                    discipline: 'Disziplin',
                    sport: 'Bewegung/Sport',
                    nutrition: 'Ernährung',
                    mindset: 'Stimmung/Mindset'
                }
            },
            en: {
                headerDate: '',
                tapHint: 'Tap for details',
                backText: 'Back',
                allCategoriesTitle: 'All Categories',
                categoriesOverview: 'Categories Overview',
                checkinTitle: 'Daily Check-in',
                checkinDone: 'Check-in for',
                checkinDoneText: 'already complete! You can view your progress.',
                checkinDoneSub: 'See you tomorrow! 🚀',
                editCheckin: 'Edit',
                sleepQuestion: 'How many hours did you sleep?',
                taskWidgetTitle: 'Task Manager',
                comingSoonBadge: 'Coming Soon',
                habitsTitle: 'Habit Tracker',
                soberTitle: 'Sober Tracker',
                habitWidgetTitle: 'Habit Tracker',
                habitStreakLabel: 'Streak',
                habitTodayLabel: 'Today',
                soberWidgetTitle: 'Sober Tracker',
                soberDaysLabel: 'Days',
                soberStreakLabel: 'Streak',
                habitComingTitle: 'Coming Soon',
                habitComingText: 'The Habit Tracker will be available soon.',
                soberComingTitle: 'Coming Soon',
                soberComingText: 'The Sober Tracker will be available soon.',
                settingsTitle: 'Settings',
                languageLabel: 'Language',
                languageDesc: 'Choose your preferred app language.',
                themeLabel: 'Theme',
                themeDesc: 'Choose between light and dark mode.',
                darkTheme: 'Dark',
                lightTheme: 'Light',
                sleepGoalLabel: 'Sleep Goal',
                sleepGoalDesc: 'Your ideal sleep goal per night. Influences your energy category.',
                coachDataLabel: 'AI Coach Data Access',
                coachDataDesc: 'Allow coach to see your values.',
                navHome: 'Home',
                navCheckin: 'Check-in',
                navCoach: 'Coach',
                navSettings: 'Settings',
                coachTitle: 'FYS Coach',
                coachPlaceholder: 'Ask a question...',
                coachWelcome: 'Hey! 👋 How can I help you?',
                submitBtn: 'Save',
                successToast: '✓ Saved!',
                categories: {
                    social: 'Social Contacts',
                    energy: 'Energy/Recovery',
                    focus: 'Focus/Productivity',
                    discipline: 'Discipline',
                    sport: 'Movement/Sport',
                    nutrition: 'Nutrition',
                    mindset: 'Mood/Mindset'
                }
            },
            es: {
                headerDate: '',
                tapHint: 'Toca para detalles',
                backText: 'Atrás',
                allCategoriesTitle: 'Todas las Categorías',
                categoriesOverview: 'Resumen de Categorías',
                checkinTitle: 'Check-in Diario',
                checkinDone: 'Check-in para',
                checkinDoneText: '¡ya completo! Puedes ver tu progreso.',
                checkinDoneSub: '¡Hasta mañana! 🚀',
                editCheckin: 'Editar',
                sleepQuestion: '¿Cuántas horas dormiste?',
                taskWidgetTitle: 'Gestor de Tareas',
                comingSoonBadge: 'Próximamente',
                habitsTitle: 'Rastreador de Hábitos',
                soberTitle: 'Rastreador de Sobriedad',
                habitWidgetTitle: 'Hábitos',
                habitStreakLabel: 'Racha',
                habitTodayLabel: 'Hoy',
                soberWidgetTitle: 'Sobriedad',
                soberDaysLabel: 'Días',
                soberStreakLabel: 'Racha',
                habitComingTitle: 'Próximamente',
                habitComingText: 'El Rastreador de Hábitos estará disponible pronto.',
                soberComingTitle: 'Próximamente',
                soberComingText: 'El Rastreador de Sobriedad estará disponible pronto.',
                settingsTitle: 'Configuración',
                languageLabel: 'Idioma',
                languageDesc: 'Elige tu idioma preferido para la aplicación.',
                themeLabel: 'Tema',
                themeDesc: 'Elige entre modo claro y oscuro.',
                darkTheme: 'Oscuro',
                lightTheme: 'Claro',
                sleepGoalLabel: 'Objetivo de Sueño',
                sleepGoalDesc: 'Tu objetivo ideal de sueño por noche. Influye en tu categoría de energía.',
                coachDataLabel: 'Acceso a Datos del Coach',
                coachDataDesc: 'Permite al coach ver tus valores.',
                navHome: 'Inicio',
                navCheckin: 'Check-in',
                navCoach: 'Coach',
                navSettings: 'Ajustes',
                coachTitle: 'Coach FYS',
                coachPlaceholder: 'Haz una pregunta...',
                coachWelcome: '¡Hola! 👋 ¿Cómo puedo ayudarte?',
                submitBtn: 'Guardar',
                successToast: '✓ ¡Guardado!',
                categories: {
                    social: 'Contactos Sociales',
                    energy: 'Energía/Recuperación',
                    focus: 'Enfoque/Productividad',
                    discipline: 'Disciplina',
                    sport: 'Movimiento/Deporte',
                    nutrition: 'Nutrición',
                    mindset: 'Estado de Ánimo'
                }
            }
        };

        // App State
        let currentLang = localStorage.getItem('fysLanguage') || 'de';
        let currentTheme = localStorage.getItem('fysTheme') || 'dark';
        let currentTimeRange = '1m';
        let sleepGoal = parseFloat(localStorage.getItem('fysSleepGoal')) || 8.0;
        let sleepHours = 8.0;
        let coachDataAccess = localStorage.getItem('fysCoachData') === 'true';
        let isPro = localStorage.getItem('fysPro') === 'true'; // Pro status
        let performanceData = JSON.parse(localStorage.getItem('fysData')) || { entries: [], activePacks: [] };
        
        // Ensure activePacks exists in loaded data
        if (!performanceData.activePacks) {
            performanceData.activePacks = [];
        }
        
        let mainChart = null;
        let combinedChart = null;
        let individualCharts = {};

        const categories = [
            { id: 'social', color: '#ffd700' },
            { id: 'energy', color: '#00ff88' },
            { id: 'focus', color: '#ff6b35' },
            { id: 'discipline', color: '#a8a8a8' },
            { id: 'sport', color: '#ff4757' },
            { id: 'nutrition', color: '#00d4ff' },
            { id: 'mindset', color: '#5f7aff' }
        ];

        // ========== PERFORMANCE PACKS DATA ==========
        const performancePacks = [
            {
                id: 'finance',
                name: 'Finance Pack',
                icon: '💰',
                description: 'Track your financial health and wealth building',
                categories: [
                    { id: 'savings', name: 'Savings', emoji: '💵', color: '#2ecc71', isPro: true },
                    { id: 'investments', name: 'Investments', emoji: '📈', color: '#3498db', isPro: true },
                    { id: 'budget', name: 'Budget Discipline', emoji: '🎯', color: '#e74c3c', isPro: true },
                    { id: 'income', name: 'Income Growth', emoji: '💼', color: '#f39c12', isPro: true },
                    { id: 'financial_education', name: 'Financial Education', emoji: '📚', color: '#9b59b6', isPro: true }
                ]
            },
            {
                id: 'health',
                name: 'Health Pack',
                icon: '🏥',
                description: 'Monitor your physical and mental wellness',
                categories: [
                    { id: 'cardio', name: 'Cardio Fitness', emoji: '🏃', color: '#e67e22', isPro: true },
                    { id: 'strength', name: 'Strength Training', emoji: '💪', color: '#c0392b', isPro: true },
                    { id: 'flexibility', name: 'Flexibility', emoji: '🧘', color: '#1abc9c', isPro: true },
                    { id: 'mental_health', name: 'Mental Health', emoji: '🧠', color: '#8e44ad', isPro: true }
                ]
            },
            {
                id: 'entrepreneurship',
                name: 'Entrepreneurship Pack',
                icon: '🚀',
                description: 'Build and scale your business ventures',
                categories: [
                    { id: 'networking', name: 'Networking', emoji: '🤝', color: '#16a085', isPro: true },
                    { id: 'product_development', name: 'Product Development', emoji: '🛠️', color: '#2980b9', isPro: true },
                    { id: 'marketing', name: 'Marketing', emoji: '📣', color: '#d35400', isPro: true },
                    { id: 'sales', name: 'Sales', emoji: '💸', color: '#27ae60', isPro: true },
                    { id: 'leadership', name: 'Leadership', emoji: '👑', color: '#8e44ad', isPro: true }
                ]
            }
        ];

        // KORRIGIERTE BERECHNUNGEN - EINFACH UND KLAR
        function calculateFYSIndex(values, previousIndex = 100) {
            // Durchschnitt aller Kategorien
            let sum = 0;
            categories.forEach(cat => {
                sum += values[cat.id] || 5;
            });
            
            const average = sum / 7;
            const dailyChange = average - 5;
            const newIndex = previousIndex + dailyChange;
            
            return Math.max(0, newIndex);
        }

        function calculateCategoryValue(checkInValue, previousValue = 100) {
            const value = parseInt(checkInValue) || 5;
            const dailyChange = value - 5;
            const newValue = previousValue + dailyChange;
            
            return Math.max(0, newValue);
        }

        // Berechne prozentuale Änderung zum Vortag
        function calculateDailyChangePercent(currentValue, previousValue) {
            if (previousValue === 0) return 0;
            return ((currentValue - previousValue) / previousValue) * 100;
        }

        // Schlaf-Bonus Berechnung
        function calculateSleepBonus(sleepHours, sleepGoal) {
            const difference = sleepHours - sleepGoal;
            
            if (Math.abs(difference) <= 0.5) {
                return 3; // Ziel erreicht
            } else if (difference > 0.5) {
                return 4; // Ziel übertroffen
            } else {
                if (difference >= -1) return -0.5;
                if (difference >= -2) return -1;
                return -2;
            }
        }

        // Get today's entry (für Testing: immer neuer Tag)
        function getTodayEntry() {
            // Für Testing: Return immer null, damit jeder Check-in ein neuer Tag ist
            return null;
        }

        // Format date
        function formatDate(date) {
            const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
            return `${days[date.getDay()]}, ${date.getDate()}. ${months[date.getMonth()]}`;
        }

        // Update header date
        function updateHeaderDate() {
            const date = new Date();
            document.getElementById('headerDate').textContent = formatDate(date);
        }

        // Adjust sleep goal
        function adjustSleepGoal(amount) {
            sleepGoal = Math.max(4, Math.min(12, sleepGoal + amount));
            localStorage.setItem('fysSleepGoal', sleepGoal);
            document.getElementById('sleepGoalValue').textContent = sleepGoal.toFixed(1) + 'h';
        }

        // Adjust sleep hours
        function adjustSleepHours(amount) {
            sleepHours = Math.max(0, Math.min(16, sleepHours + amount));
            document.getElementById('sleepHoursValue').textContent = sleepHours.toFixed(1) + 'h';
        }

        // Update check-in view
        function updateCheckinView() {
            const t = translations[currentLang];
            const container = document.getElementById('checkinContainer');
            const todayEntry = getTodayEntry();
            
            if (todayEntry && !container.querySelector('#checkinForm')) {
                const today = new Date();
                container.innerHTML = `
                    <div class="checkin-status">
                        <div class="status-icon">✓</div>
                        <div class="status-title">${t.checkinDone} ${formatDate(today)}</div>
                        <div class="status-subtitle">${t.checkinDoneText}</div>
                        <button class="edit-btn" onclick="editCheckin()">${t.editCheckin}</button>
                        <div style="margin-top: 16px; font-size: 13px; color: var(--text-secondary);">${t.checkinDoneSub}</div>
                    </div>
                `;
            } else if (!todayEntry) {
                container.innerHTML = '<div id="checkinForm"></div>';
                updateCheckinForm();
            }
        }

        // Edit check-in
        function editCheckin() {
            const container = document.getElementById('checkinContainer');
            container.innerHTML = '<div id="checkinForm"></div>';
            updateCheckinForm();
        }

        // Update check-in form
        function updateCheckinForm() {
            const t = translations[currentLang];
            const form = document.getElementById('checkinForm');
            const todayEntry = getTodayEntry();
            
            form.innerHTML = '';
            
            const categoryIcons = {
                social: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
                energy: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
                focus: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`,
                discipline: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
                sport: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.73 4a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
                nutrition: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>`,
                mindset: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>`
            };
            
            // Regular categories with Icons
            categories.forEach(cat => {
                const value = (todayEntry && todayEntry.values && todayEntry.values[cat.id]) ? todayEntry.values[cat.id] : 10;
                form.innerHTML += `
                    <div class="category-input">
                        <div class="category-label">
                            <div class="input-category-name">
                                <div class="input-category-icon" style="background: ${cat.color}20; color: ${cat.color};">
                                    ${categoryIcons[cat.id]}
                                </div>
                                ${t.categories[cat.id]}
                            </div>
                            <div class="category-value-display" id="${cat.id}Value">${value}</div>
                        </div>
                        <input type="range" min="1" max="10" value="${value}" class="slider" id="${cat.id}Slider">
                    </div>
                `;
            });
            
            // Sleep input (last)
            const sleepValue = todayEntry ? todayEntry.sleepHours : 8.0;
            sleepHours = sleepValue;
            form.innerHTML += `
                <div class="sleep-input">
                    <div class="sleep-label">😴 ${t.sleepQuestion}</div>
                    <div class="sleep-value-display" id="sleepHoursValue">${sleepValue.toFixed(1)}h</div>
                    <div class="sleep-controls">
                        <button class="sleep-btn" onclick="adjustSleepHours(-0.5)">−</button>
                        <button class="sleep-btn" onclick="adjustSleepHours(0.5)">+</button>
                    </div>
                </div>
            `;
            
            form.innerHTML += `<button class="submit-btn" onclick="submitCheckIn()">${t.submitBtn}</button>`;
            initSliders();
        }

        // Initialize sliders
        function initSliders() {
            categories.forEach(cat => {
                const slider = document.getElementById(`${cat.id}Slider`);
                const value = document.getElementById(`${cat.id}Value`);
                
                if (slider && value) {
                    slider.addEventListener('input', function() {
                        value.textContent = this.value;
                    });
                }
            });
        }

        // Submit check-in
        function submitCheckIn() {
            console.log('=== CHECK-IN START ===');
            console.log('Categories:', categories);
            console.log('performanceData:', performanceData);
            
            try {
                // 1. Werte von Slidern sammeln
                const values = {};
                
                console.log('Collecting slider values...');
                categories.forEach(cat => {
                    console.log(`Looking for slider: ${cat.id}Slider`);
                    const slider = document.getElementById(`${cat.id}Slider`);
                    console.log(`Found slider for ${cat.id}:`, slider);
                    
                    if (slider) {
                        values[cat.id] = parseInt(slider.value);
                        console.log(`Set ${cat.id} = ${values[cat.id]}`);
                    } else {
                        values[cat.id] = 5;
                        console.log(`Default ${cat.id} = 5`);
                    }
                });
                
                console.log('Final values:', values);

                // 2. Prüfen ob erster Eintrag
                const isFirstEntry = performanceData.entries.length === 0;
                console.log('Is first entry?', isFirstEntry);
                
                // 3. Datum bestimmen
                let entryDate;
                if (isFirstEntry) {
                    entryDate = new Date();
                } else {
                    const lastEntry = performanceData.entries[performanceData.entries.length - 1];
                    entryDate = new Date(lastEntry.date);
                    entryDate.setDate(entryDate.getDate() + 1);
                }
                console.log('Entry date:', entryDate);

                // 4. Berechnung
                let fysIndex;
                const categoryValues = {};
                
                if (isFirstEntry) {
                    console.log('FIRST ENTRY - Setting everything to 100');
                    // ERSTER CHECK-IN: Alles auf 100
                    fysIndex = 100;
                    categories.forEach(cat => {
                        categoryValues[cat.id] = 100;
                    });
                } else {
                    console.log('SUBSEQUENT ENTRY - Calculating');
                    // FOLGENDE CHECK-INS: Berechnen
                    const lastEntry = performanceData.entries[performanceData.entries.length - 1];
                    console.log('Last entry:', lastEntry);
                    
                    console.log('Calling calculateFYSIndex with:', values, lastEntry.fysIndex);
                    fysIndex = calculateFYSIndex(values, lastEntry.fysIndex);
                    console.log('Calculated FYS Index:', fysIndex);
                    
                    categories.forEach(cat => {
                        const prevValue = lastEntry.categoryValues[cat.id] || 100;
                        categoryValues[cat.id] = calculateCategoryValue(values[cat.id], prevValue);
                        console.log(`Category ${cat.id}: ${prevValue} -> ${categoryValues[cat.id]}`);
                    });
                }

                console.log('Final FYS Index:', fysIndex);
                console.log('Final category values:', categoryValues);

                // 5. Speichern
                const newEntry = {
                    date: entryDate.toISOString(),
                    values: values,
                    categoryValues: categoryValues,
                    sleepHours: sleepHours,
                    fysIndex: fysIndex
                };
                
                console.log('New entry to save:', newEntry);
                performanceData.entries.push(newEntry);
                localStorage.setItem('fysData', JSON.stringify(performanceData));
                console.log('Saved to localStorage');

                // 6. UI Update - Better feedback
                const toast = document.getElementById('successToast');
                if (toast) {
                    toast.textContent = '✓ Gespeichert!';
                    toast.classList.add('show');
                }
                
                // Wait longer for user to see the toast, then reload
                setTimeout(() => {
                    console.log('Reloading page...');
                    location.reload();
                }, 2500);
                
                console.log('=== CHECK-IN SUCCESS ===');
                
            } catch (error) {
                console.error('=== CHECK-IN ERROR ===');
                console.error('Error:', error);
                console.error('Stack:', error.stack);
                alert('Fehler beim Speichern: ' + error.message);
            }
        }

        // Show toast
        function showToast() {
            const toast = document.getElementById('successToast');
            const t = translations[currentLang];
            toast.textContent = t.successToast;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // Initialize main chart
        function initMainChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'FYS-Index',
                        data: [],
                        borderColor: '#ff6b35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: currentTheme === 'dark' ? 'rgba(17, 17, 17, 0.95)' : 'rgba(255, 255, 255, 0.98)',
                            titleColor: currentTheme === 'dark' ? '#ffffff' : '#ff6b35',
                            bodyColor: currentTheme === 'dark' ? '#6b6b6b' : '#ff8f5f',
                            borderColor: currentTheme === 'dark' ? '#1a1a1a' : '#ffe8e0',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                // Zeige nur den Wert (ohne "FYS-Index:")
                                title: function(context) {
                                    return context[0].parsed.y.toFixed(1);
                                },
                                // Zeige Datum als Body (unten)
                                label: function(context) {
                                    return context.label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { display: false }
                        },
                        y: {
                            // Auto-Scale für Trading-Platform-Look
                            beginAtZero: false,
                            grace: '5%', // 5% Padding oben und unten für bessere Sicht
                            grid: { 
                                color: currentTheme === 'dark' ? '#1a1a1a' : '#fff5f0', 
                                drawBorder: false 
                            },
                            ticks: { 
                                color: currentTheme === 'dark' ? '#404040' : '#ff8f5f', 
                                font: { size: 10 },
                                padding: 5
                            }
                        }
                    }
                }
            });
        }

        // Update main chart
        function updateMainChart() {
            console.log('updateMainChart called');
            console.log('mainChart exists?', !!mainChart);
            console.log('entries count:', performanceData.entries.length);
            
            if (!mainChart) {
                console.log('mainChart is null, skipping chart update');
            }
            
            if (performanceData.entries.length === 0) {
                console.log('No entries, skipping chart update');
                return;
            }

            const entries = getFilteredEntries();
            console.log('Filtered entries:', entries.length);
            
            if (mainChart) {
                mainChart.data.labels = entries.map(e => {
                    const date = new Date(e.date);
                    const day = date.getDate();
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    // Format: "23.1.2026" für Tooltip
                    return `${day}.${month}.${year}`;
                });

                mainChart.data.datasets[0].data = entries.map(e => e.fysIndex);
                mainChart.update('none');
                console.log('Chart updated with', entries.length, 'entries');
            }

            if (entries.length > 0) {
                const latest = entries[entries.length - 1];
                const first = entries[0];
                const change = latest.fysIndex - first.fysIndex;
                
                const valueEl = document.getElementById('mainIndexValue');
                if (valueEl) {
                    valueEl.textContent = latest.fysIndex.toFixed(1);
                    console.log('Set main index value to:', latest.fysIndex.toFixed(1));
                }
                
                if (change > 0) {
                    valueEl.className = 'index-value-number positive';
                } else if (change < 0) {
                    valueEl.className = 'index-value-number negative';
                } else {
                    valueEl.className = 'index-value-number';
                }

                const changePercent = ((change / first.fysIndex) * 100).toFixed(2);
                const changeText = document.getElementById('mainChangeText');
                if (changeText) {
                    changeText.textContent = `${change >= 0 ? '+' : ''}${changePercent}%`;
                    // Farbe basierend auf Änderung
                    if (change > 0) {
                        changeText.style.color = '#00c96d';
                    } else if (change < 0) {
                        changeText.style.color = '#ff3366';
                    } else {
                        changeText.style.color = 'var(--text-secondary)';
                    }
                }
            }
        }

        // Get filtered entries
        function getFilteredEntries() {
            if (performanceData.entries.length === 0) return [];
            
            // Verwende das letzte Datum in den Daten, nicht heute
            const lastEntry = performanceData.entries[performanceData.entries.length - 1];
            const lastDate = new Date(lastEntry.date);
            
            let startDate;
            
            switch(currentTimeRange) {
                case '1d':
                    startDate = new Date(lastDate.getTime() - 1 * 24 * 60 * 60 * 1000);
                    break;
                case '7d':
                    startDate = new Date(lastDate.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case '1m':
                    startDate = new Date(lastDate.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case '6m':
                    startDate = new Date(lastDate.getTime() - 180 * 24 * 60 * 60 * 1000);
                    break;
                case '1y':
                    startDate = new Date(lastDate.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                    return performanceData.entries;
            }
            
            const filtered = performanceData.entries.filter(e => new Date(e.date) >= startDate);
            console.log(`Filtered entries for ${currentTimeRange}:`, filtered.length, 'out of', performanceData.entries.length);
            return filtered;
        }

        // Change time range
        function changeTimeRange(range) {
            console.log('Changing time range to:', range);
            currentTimeRange = range;
            
            // Save to localStorage
            localStorage.setItem('fys_timeRange', range);
            
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            const targetBtn = document.querySelector(`[data-range="${range}"]`);
            if (targetBtn) targetBtn.classList.add('active');
            
            updateMainChart();
            createStockList(); // Update category list
            
            // Update Performance Pack charts (synchronized!)
            if (isPro && performanceData.activePacks && performanceData.activePacks.length > 0) {
                performanceData.activePacks.forEach(packId => {
                    createPackMiniChart(packId);
                });
                console.log('✓ Pack charts updated with new timerange');
            }
            
            console.log('Time range changed and saved:', range);
        }

        // Open chart details (Flatex-Style)
        function openChartDetails() {
            console.log('openChartDetails called, entries:', performanceData.entries.length);
            
            // Öffne View auch wenn keine Daten vorhanden (für Demo)
            document.getElementById('homeView').classList.remove('active');
            document.getElementById('chartDetailsView').classList.add('active');
            
            // Update FYS Index Summary
            const entries = getFilteredEntries();
            console.log('Filtered entries:', entries.length);
            
            if (entries.length > 0) {
                const latest = entries[entries.length - 1];
                const first = entries[0];
                const change = latest.fysIndex - first.fysIndex;
                const changePercent = ((change / first.fysIndex) * 100).toFixed(2);
                
                document.getElementById('detailIndexValue').textContent = latest.fysIndex.toFixed(1);
                document.getElementById('detailIndexChange').textContent = 
                    `${change >= 0 ? '+' : ''}${changePercent}%`;
            } else {
                // Demo-Werte wenn keine Daten
                document.getElementById('detailIndexValue').textContent = '100.0';
                document.getElementById('detailIndexChange').textContent = '+0.00%';
            }
            
            // Create Flatex-Style Stock List
            createStockList();
            
            // Update charts
            try {
                if (!combinedChart) initCombinedChart();
                if (entries.length > 0) {
                    updateCombinedChart();
                }
            } catch (error) {
                console.error('Chart error:', error);
            }
        }

        function closeChartDetails() {
            document.getElementById('chartDetailsView').classList.remove('active');
            document.getElementById('homeView').classList.add('active');
            
            // Reset label back to FYS-INDEX
            const indexLabel = document.querySelector('#chartDetailsView .fys-index-label');
            if (indexLabel) {
                indexLabel.textContent = 'FYS-INDEX';
            }
            
            // Clean up pack values table if it exists
            const packTable = document.getElementById('packValuesTableContainer');
            if (packTable) {
                packTable.remove();
            }
        }

        // Create Flatex-Style Stock List
        function createStockList() {
            const t = translations[currentLang];
            const container = document.getElementById('stockListItems');
            
            if (!container) {
                console.error('stockListItems container not found!');
                return;
            }
            
            container.innerHTML = '';

            const entries = getFilteredEntries();
            console.log('createStockList entries:', entries.length);

            // Category SVG Icons (im Bottom Nav Stil)
            const categoryIcons = {
                social: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
                energy: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
                focus: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`,
                discipline: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
                sport: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.73 4a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
                nutrition: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>`,
                mindset: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>`
            };

            // Wenn keine Daten, zeige Demo-Werte
            if (entries.length === 0) {
                categories.forEach(cat => {
                    const stockItem = document.createElement('div');
                    stockItem.className = 'stock-item';
                    
                    stockItem.innerHTML = `
                        <div class="stock-item-left">
                            <div class="stock-icon" style="background: ${cat.color}20; color: ${cat.color};">
                                ${categoryIcons[cat.id]}
                            </div>
                            <div class="stock-info">
                                <div class="stock-name">${t.categories[cat.id]}</div>
                                <div class="stock-symbol">${cat.id.toUpperCase()}</div>
                            </div>
                        </div>
                        <div class="stock-item-right">
                            <div class="stock-price">100.0</div>
                            <div class="stock-change neutral">
                                <span class="stock-arrow">—</span>
                                0.0%
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(stockItem);
                });
                return;
            }

            const latest = entries[entries.length - 1];
            const first = entries[0];

            categories.forEach(cat => {
                // Verwende categoryValues (akkumuliert) statt values * 10
                const latestValue = latest.categoryValues ? latest.categoryValues[cat.id] : 100;
                const firstValue = first.categoryValues ? first.categoryValues[cat.id] : 100;
                const change = latestValue - firstValue;
                const changePercent = firstValue !== 0 ? ((change / firstValue) * 100).toFixed(1) : '0.0';
                
                const isPositive = change > 0;
                const isNegative = change < 0;
                const changeClass = isPositive ? 'positive' : isNegative ? 'negative' : 'neutral';
                const arrow = isPositive ? '▲' : isNegative ? '▼' : '—';

                const stockItem = document.createElement('div');
                stockItem.className = 'stock-item';
                stockItem.onclick = () => showCategoryDetail(cat.id);
                
                stockItem.innerHTML = `
                    <div class="stock-item-left">
                        <div class="stock-icon" style="background: ${cat.color}20; color: ${cat.color};">
                            ${categoryIcons[cat.id]}
                        </div>
                        <div class="stock-info">
                            <div class="stock-name">${t.categories[cat.id]}</div>
                            <div class="stock-symbol">${cat.id.toUpperCase()}</div>
                        </div>
                    </div>
                    <div class="stock-item-right">
                        <div class="stock-price">${latestValue.toFixed(1)}</div>
                        <div class="stock-change ${changeClass}">
                            <span class="stock-arrow">${arrow}</span>
                            ${Math.abs(parseFloat(changePercent)).toFixed(1)}%
                        </div>
                    </div>
                `;
                
                container.appendChild(stockItem);
            });
        }

        // Create Stock List for Performance Pack Categories (1:1 copy)
        function createPackStockList(pack) {
            const container = document.getElementById('stockListItems');
            const categoriesOverview = document.getElementById('categoriesOverview');
            
            if (!container) {
                console.error('stockListItems container not found!');
                return;
            }
            
            // Update title
            if (categoriesOverview) {
                categoriesOverview.textContent = `${pack.name} Kategorien`;
            }
            
            container.innerHTML = '';

            const entries = getFilteredEntries().filter(e => 
                e.packIndices && e.packIndices[pack.id] !== undefined
            );

            console.log('createPackStockList entries:', entries.length);

            // SVG Icons for pack categories (same as in settings)
            const packCategoryIcons = {
                // Finance Pack
                savings: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>`,
                investments: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>`,
                budget: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 18V6"></path></svg>`,
                income: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>`,
                financial_education: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
                
                // Health Pack
                cardio: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>`,
                strength: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 6.5v11M17.5 6.5v11M3 9.5h3M18 9.5h3M3 14.5h3M18 14.5h3M9 3v3M15 3v3M9 18v3M15 18v3"></path></svg>`,
                flexibility: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path></svg>`,
                mental_health: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 14 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>`,
                
                // Entrepreneurship Pack
                networking: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
                product_development: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>`,
                marketing: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0L21.3 15.3z"></path><path d="M7.5 10.5L14 17"></path></svg>`,
                sales: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
                leadership: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20h20M5 20V9l7-5 7 5v11M9 20v-6h6v6"></path></svg>`
            };

            // If no data, show demo values
            if (entries.length === 0) {
                pack.categories.forEach(cat => {
                    const stockItem = document.createElement('div');
                    stockItem.className = 'stock-item';
                    
                    stockItem.innerHTML = `
                        <div class="stock-item-left">
                            <div class="stock-icon" style="background: ${cat.color}20; color: ${cat.color};">
                                ${packCategoryIcons[cat.id] || cat.emoji}
                            </div>
                            <div class="stock-info">
                                <div class="stock-name">${cat.name}</div>
                                <div class="stock-symbol">${cat.id.toUpperCase()}</div>
                            </div>
                        </div>
                        <div class="stock-item-right">
                            <div class="stock-price">5.0</div>
                            <div class="stock-change neutral">
                                <span class="stock-arrow">—</span>
                                0.0%
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(stockItem);
                });
                return;
            }

            const latest = entries[entries.length - 1];
            const first = entries[0];

            pack.categories.forEach(cat => {
                const latestValue = latest.values ? latest.values[cat.id] : 5;
                const firstValue = first.values ? first.values[cat.id] : 5;
                const change = latestValue - firstValue;
                const changePercent = firstValue !== 0 ? ((change / firstValue) * 100).toFixed(1) : '0.0';
                
                const isPositive = change > 0;
                const isNegative = change < 0;
                const changeClass = isPositive ? 'positive' : isNegative ? 'negative' : 'neutral';
                const arrow = isPositive ? '▲' : isNegative ? '▼' : '—';

                const stockItem = document.createElement('div');
                stockItem.className = 'stock-item';
                stockItem.onclick = () => showPackCategoryDetail(pack.id, cat.id);
                
                stockItem.innerHTML = `
                    <div class="stock-item-left">
                        <div class="stock-icon" style="background: ${cat.color}20; color: ${cat.color};">
                            ${packCategoryIcons[cat.id] || cat.emoji}
                        </div>
                        <div class="stock-info">
                            <div class="stock-name">${cat.name}</div>
                            <div class="stock-symbol">${cat.id.toUpperCase()}</div>
                        </div>
                    </div>
                    <div class="stock-item-right">
                        <div class="stock-price">${latestValue.toFixed(1)}</div>
                        <div class="stock-change ${changeClass}">
                            <span class="stock-arrow">${arrow}</span>
                            ${Math.abs(parseFloat(changePercent)).toFixed(1)}%
                        </div>
                    </div>
                `;
                
                container.appendChild(stockItem);
            });
        }

        // Show individual pack category detail
        function showPackCategoryDetail(packId, categoryId) {
            // For now, just log - can be extended like showCategoryDetail
            console.log('Show pack category detail:', packId, categoryId);
            // TODO: Implement modal for pack category details (like FYS Index categories)
        }

        // Category Detail View
        let categoryDetailChart = null;
        let currentCategoryTimeRange = '1m';
        let currentCategoryId = null;

        // Show individual category detail
        function showCategoryDetail(categoryId) {
            const t = translations[currentLang];
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;

            currentCategoryId = categoryId;

            const categoryIcons = {
                social: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
                energy: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
                focus: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`,
                discipline: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
                sport: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.73 4a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
                nutrition: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>`,
                mindset: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>`
            };

            // Update Header
            const iconContainer = document.getElementById('categoryDetailIcon');
            iconContainer.style.background = `${category.color}20`;
            iconContainer.style.color = category.color;
            iconContainer.innerHTML = categoryIcons[categoryId];
            
            document.getElementById('categoryDetailName').textContent = t.categories[categoryId];
            document.getElementById('categoryDetailSymbol').textContent = categoryId.toUpperCase();

            // Update Price
            updateCategoryDetailData();

            // Show Modal
            document.getElementById('categoryDetailModal').classList.add('active');

            // Initialize Chart
            if (!categoryDetailChart) {
                initCategoryDetailChart();
            }
            updateCategoryDetailChart();
        }

        function closeCategoryDetail() {
            document.getElementById('categoryDetailModal').classList.remove('active');
        }

        function updateCategoryDetailData() {
            const category = categories.find(c => c.id === currentCategoryId);
            if (!category) return;

            const entries = getCategoryFilteredEntries();
            if (entries.length === 0) {
                document.getElementById('categoryDetailPrice').textContent = '100.0';
                document.getElementById('categoryDetailChange').innerHTML = '<span>—</span> 0.0%';
                document.getElementById('categoryDetailChange').className = 'category-detail-change neutral';
                return;
            }

            const latest = entries[entries.length - 1];
            const first = entries[0];
            
            // Verwende categoryValues statt values * 10
            const latestValue = latest.categoryValues ? latest.categoryValues[currentCategoryId] : 100;
            const firstValue = first.categoryValues ? first.categoryValues[currentCategoryId] : 100;
            const change = latestValue - firstValue;
            const changePercent = firstValue !== 0 ? ((change / firstValue) * 100).toFixed(1) : '0.0';

            const isPositive = change > 0;
            const isNegative = change < 0;
            const changeClass = isPositive ? 'positive' : isNegative ? 'negative' : 'neutral';
            const arrow = isPositive ? '▲' : isNegative ? '▼' : '—';

            document.getElementById('categoryDetailPrice').textContent = latestValue.toFixed(1);
            document.getElementById('categoryDetailPrice').style.color = category.color;
            
            const changeEl = document.getElementById('categoryDetailChange');
            changeEl.className = `category-detail-change ${changeClass}`;
            changeEl.innerHTML = `<span>${arrow}</span> ${Math.abs(parseFloat(changePercent)).toFixed(1)}%`;
        }

        function changeCategoryTimeRange(range) {
            currentCategoryTimeRange = range;
            document.querySelectorAll('.category-time-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-cat-range="${range}"]`).classList.add('active');
            updateCategoryDetailData();
            updateCategoryDetailChart();
        }

        // Get filtered entries for category view
        function getCategoryFilteredEntries() {
            if (performanceData.entries.length === 0) return [];
            
            // Verwende das letzte Datum in den Daten, nicht heute (wie bei Main Chart)
            const lastEntry = performanceData.entries[performanceData.entries.length - 1];
            const lastDate = new Date(lastEntry.date);
            let startDate;
            
            switch(currentCategoryTimeRange) {
                case '1d':
                    startDate = new Date(lastDate.getTime() - 1 * 24 * 60 * 60 * 1000);
                    break;
                case '7d':
                    startDate = new Date(lastDate.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case '1m':
                    startDate = new Date(lastDate.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case '6m':
                    startDate = new Date(lastDate.getTime() - 180 * 24 * 60 * 60 * 1000);
                    break;
                case '1y':
                    startDate = new Date(lastDate.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                    return performanceData.entries;
            }
            
            return performanceData.entries.filter(e => new Date(e.date) >= startDate);
        }

        // Initialize Category Detail Chart with Interactive Tooltip
        function initCategoryDetailChart() {
            const ctx = document.getElementById('categoryDetailChart').getContext('2d');
            const category = categories.find(c => c.id === currentCategoryId);
            
            categoryDetailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Value',
                        data: [],
                        borderColor: category.color,
                        backgroundColor: `${category.color}20`,
                        borderWidth: 3,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: category.color,
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { 
                        mode: 'index', 
                        intersect: false 
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: currentTheme === 'dark' ? 'rgba(17, 17, 17, 0.95)' : 'rgba(255, 255, 255, 0.98)',
                            titleColor: currentTheme === 'dark' ? '#ffffff' : '#ff6b35',
                            bodyColor: currentTheme === 'dark' ? '#6b6b6b' : '#ff8f5f',
                            borderColor: currentTheme === 'dark' ? '#1a1a1a' : '#ffe8e0',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                // Zeige nur den Wert (wie Main Chart)
                                title: function(context) {
                                    return context[0].parsed.y.toFixed(1);
                                },
                                // Zeige Datum als Body (unten)
                                label: function(context) {
                                    return context.label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { 
                                color: currentTheme === 'dark' ? '#1a1a1a' : '#fff5f0', 
                                drawBorder: false 
                            },
                            ticks: { 
                                color: currentTheme === 'dark' ? '#404040' : '#ff8f5f', 
                                font: { size: 10 } 
                            }
                        },
                        y: {
                            // Auto-Scale für Trading-Platform-Look
                            beginAtZero: false,
                            grace: '5%', // 5% Padding oben und unten
                            grid: { 
                                color: currentTheme === 'dark' ? '#1a1a1a' : '#fff5f0', 
                                drawBorder: false 
                            },
                            ticks: { 
                                color: currentTheme === 'dark' ? '#404040' : '#ff8f5f', 
                                font: { size: 10 },
                                padding: 5
                            }
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        }

        // Update Category Detail Chart
        function updateCategoryDetailChart() {
            if (!categoryDetailChart) return;

            const category = categories.find(c => c.id === currentCategoryId);
            const entries = getCategoryFilteredEntries();
            
            if (entries.length === 0) {
                categoryDetailChart.data.labels = [];
                categoryDetailChart.data.datasets[0].data = [];
                categoryDetailChart.update();
                return;
            }

            categoryDetailChart.data.labels = entries.map(e => {
                const date = new Date(e.date);
                return `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`;
            });

            // Verwende categoryValues
            categoryDetailChart.data.datasets[0].data = entries.map(e => 
                e.categoryValues ? e.categoryValues[currentCategoryId] : 100
            );

            // Update colors
            categoryDetailChart.data.datasets[0].borderColor = category.color;
            categoryDetailChart.data.datasets[0].backgroundColor = `${category.color}20`;
            categoryDetailChart.data.datasets[0].pointHoverBackgroundColor = category.color;

            categoryDetailChart.update('none');
        }

        // Initialize combined chart
        function initCombinedChart() {
            const ctx = document.getElementById('combinedChart').getContext('2d');
            const t = translations[currentLang];
            
            const datasets = categories.map(cat => ({
                label: t.categories[cat.id],
                data: [],
                borderColor: cat.color,
                backgroundColor: 'transparent',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 5
            }));

            datasets.push({
                label: 'FYS-Index',
                data: [],
                borderColor: '#ff6b35',
                backgroundColor: 'transparent',
                borderWidth: 3,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6
            });

            combinedChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: currentTheme === 'dark' ? 'rgba(17, 17, 17, 0.95)' : 'rgba(255, 255, 255, 0.98)',
                            titleColor: currentTheme === 'dark' ? '#ffffff' : '#ff6b35',
                            bodyColor: currentTheme === 'dark' ? '#6b6b6b' : '#ff8f5f',
                            borderColor: currentTheme === 'dark' ? '#1a1a1a' : '#ffe8e0',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                // Wert oben
                                title: function(context) {
                                    return context[0].dataset.label + ': ' + context[0].parsed.y.toFixed(1);
                                },
                                // Datum unten
                                label: function(context) {
                                    return context.label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { 
                                color: currentTheme === 'dark' ? '#1a1a1a' : '#fff5f0', 
                                drawBorder: false 
                            },
                            ticks: { 
                                color: currentTheme === 'dark' ? '#404040' : '#ff8f5f', 
                                font: { size: 10 } 
                            }
                        },
                        y: {
                            // Auto-Scale für Trading-Platform-Look
                            beginAtZero: false,
                            grace: '5%',
                            grid: { 
                                color: currentTheme === 'dark' ? '#1a1a1a' : '#fff5f0', 
                                drawBorder: false 
                            },
                            ticks: { 
                                color: currentTheme === 'dark' ? '#404040' : '#ff8f5f', 
                                font: { size: 10 },
                                padding: 5
                            }
                        }
                    }
                }
            });
        }

        // Update combined chart
        function updateCombinedChart() {
            if (!combinedChart) return;

            const entries = getFilteredEntries();
            
            combinedChart.data.labels = entries.map(e => {
                const date = new Date(e.date);
                return `${date.getDate()}.${date.getMonth() + 1}`;
            });

            categories.forEach((cat, index) => {
                // Verwende categoryValues
                combinedChart.data.datasets[index].data = entries.map(e => 
                    e.categoryValues ? e.categoryValues[cat.id] : 100
                );
            });

            combinedChart.data.datasets[combinedChart.data.datasets.length - 1].data = entries.map(e => e.fysIndex);
            combinedChart.update();
        }

        // Create individual charts
        function createIndividualCharts() {
            const t = translations[currentLang];
            const container = document.getElementById('individualCharts');
            container.innerHTML = '';

            categories.forEach(cat => {
                const chartCard = document.createElement('div');
                chartCard.className = 'chart-card';
                chartCard.innerHTML = `
                    <div class="chart-title">${t.categories[cat.id]}</div>
                    <div class="single-chart-container">
                        <canvas id="chart-${cat.id}"></canvas>
                    </div>
                `;
                container.appendChild(chartCard);

                const ctx = document.getElementById(`chart-${cat.id}`).getContext('2d');
                const entries = getFilteredEntries();

                individualCharts[cat.id] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: entries.map(e => {
                            const date = new Date(e.date);
                            return `${date.getDate()}.${date.getMonth() + 1}`;
                        }),
                        datasets: [{
                            label: t.categories[cat.id],
                            data: entries.map(e => (e.values[cat.id] || 10) * 10),
                            borderColor: cat.color,
                            backgroundColor: `${cat.color}20`,
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: currentTheme === 'dark' ? 'rgba(17, 17, 17, 0.95)' : 'rgba(255, 255, 255, 0.98)',
                                titleColor: currentTheme === 'dark' ? '#ffffff' : '#ff6b35',
                                bodyColor: currentTheme === 'dark' ? '#6b6b6b' : '#ff8f5f',
                                borderColor: currentTheme === 'dark' ? '#1a1a1a' : '#ffe8e0',
                                borderWidth: 1,
                                padding: 12
                            }
                        },
                        scales: {
                            x: {
                                grid: { 
                                    color: currentTheme === 'dark' ? '#1a1a1a' : '#fff5f0', 
                                    drawBorder: false 
                                },
                                ticks: { 
                                    color: currentTheme === 'dark' ? '#404040' : '#ff8f5f', 
                                    font: { size: 10 } 
                                }
                            },
                            y: {
                                // Auto-Scale für Trading-Platform-Look
                                beginAtZero: false,
                                grace: '5%',
                                grid: { 
                                    color: currentTheme === 'dark' ? '#1a1a1a' : '#fff5f0', 
                                    drawBorder: false 
                                },
                                ticks: { 
                                    color: currentTheme === 'dark' ? '#404040' : '#ff8f5f', 
                                    font: { size: 10 },
                                    padding: 5
                                }
                            }
                        }
                    }
                });
            });
        }

        // Change theme
        function changeTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('fysTheme', theme);
            document.documentElement.setAttribute('data-theme', theme);
            
            document.querySelectorAll('[data-theme-btn]').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-theme-btn="${theme}"]`).classList.add('active');
            
            if (mainChart) {
                mainChart.destroy();
                initMainChart();
                updateMainChart();
            }
        }

        // Change language
        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('fysLanguage', lang);
            
            document.querySelectorAll('[data-lang]').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-lang="${lang}"]`).classList.add('active');
            
            updateUI();
        }

        // Toggle coach data
        function toggleCoachData() {
            coachDataAccess = !coachDataAccess;
            localStorage.setItem('fysCoachData', coachDataAccess);
            const toggle = document.getElementById('coachDataToggle');
            
            if (coachDataAccess) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        function togglePro() {
            isPro = !isPro;
            localStorage.setItem('fysPro', isPro);
            
            // Update button
            updateProButton();
            
            // Show/Hide Performance Packs
            renderPerformancePacks();
            
            // Show message
            if (isPro) {
                alert('🎉 FYS Pro aktiviert! Performance Packs sind jetzt auf dem Startbildschirm verfügbar.');
            } else {
                alert('FYS Pro deaktiviert. Performance Packs wurden ausgeblendet.');
            }
        }

        function updateProButton() {
            const btn = document.getElementById('proToggleBtn');
            const desc = document.getElementById('proStatusDesc');
            
            if (btn && desc) {
                if (isPro) {
                    btn.textContent = 'Deactivate FYS Pro';
                    btn.style.background = 'linear-gradient(135deg, #666, #888)';
                    desc.textContent = 'Pro Status: Active ✓';
                } else {
                    btn.textContent = 'Activate FYS Pro';
                    btn.style.background = 'linear-gradient(135deg, #ff6b35, #ff8f5f)';
                    desc.textContent = 'Performance Packs & Advanced Features';
                }
            }
            
            // Show/hide pack settings
            renderPackSettings();
        }

        // Update UI
        // ========== PERFORMANCE PACKS FUNCTIONS ==========
        function getActivePackCategories() {
            let packCategories = [];
            
            try {
                if (!performanceData || !performanceData.activePacks) {
                    console.warn('No active packs data available');
                    return packCategories;
                }
                
                performanceData.activePacks.forEach(packId => {
                    const pack = performancePacks.find(p => p.id === packId);
                    if (pack && pack.categories && Array.isArray(pack.categories)) {
                        packCategories = packCategories.concat(pack.categories);
                        console.log('✓ Added categories from pack:', packId, '→', pack.categories.length, 'categories');
                    } else {
                        console.warn('Pack not found or invalid:', packId);
                    }
                });
            } catch (error) {
                console.error('Error in getActivePackCategories:', error);
            }
            
            return packCategories;
        }

        function calculatePackIndex(packId, values, previousIndex) {
            const pack = performancePacks.find(p => p.id === packId);
            if (!pack) return 100;

            const packCategoryIds = pack.categories.map(c => c.id);
            let sum = 0;
            let count = 0;

            packCategoryIds.forEach(catId => {
                if (values[catId] !== undefined) {
                    sum += values[catId];
                    count++;
                }
            });

            if (count === 0) return previousIndex;

            const avg = sum / count;
            const change = avg - 5;
            return Math.max(0, previousIndex + change);
        }

        function togglePerformancePack(packId) {
            const index = performanceData.activePacks.indexOf(packId);
            
            if (index > -1) {
                // Deactivate pack
                performanceData.activePacks.splice(index, 1);
            } else {
                // Check limit
                if (performanceData.activePacks.length >= 2) {
                    alert('⚠️ Du kannst maximal 2 Performance Packs gleichzeitig aktivieren. Deaktiviere zuerst ein anderes Pack.');
                    return;
                }
                // Activate pack
                performanceData.activePacks.push(packId);
            }
            
            // Save to localStorage
            localStorage.setItem('fysData', JSON.stringify(performanceData));
            localStorage.setItem('fys_activePacks', JSON.stringify(performanceData.activePacks));
            
            console.log('✓ Performance Pack toggled:', packId);
            console.log('  Active packs:', performanceData.activePacks);
            
            renderPackSettings();
            renderPerformancePacks();
            renderPerformancePacks(); // Update home view
            updateUI(); // Update check-in question count
        }

        function renderPackSettings() {
            const container = document.getElementById('performancePacksSettings');
            const listContainer = document.getElementById('packSettingsList');
            const countSpan = document.getElementById('activePacksCount');

            if (!isPro) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            
            const activeCount = performanceData.activePacks.length;
            if (countSpan) countSpan.textContent = activeCount;

            listContainer.innerHTML = '';

            // SVG Icons for pack categories (same as in stock list)
            const packCategoryIcons = {
                // Finance Pack
                savings: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>`,
                investments: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>`,
                budget: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><circle cx="12" cy="12" r="10"></circle><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 18V6"></path></svg>`,
                income: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M20 12H4M20 12l-4-4M20 12l-4 4"></path></svg>`,
                financial_education: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
                
                // Health Pack
                cardio: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>`,
                strength: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M6.5 6.5v11M17.5 6.5v11M3 9.5h3M18 9.5h3M3 14.5h3M18 14.5h3M9 3v3M15 3v3M9 18v3M15 18v3"></path></svg>`,
                flexibility: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path></svg>`,
                mental_health: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 14 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>`,
                
                // Entrepreneurship Pack
                networking: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
                product_development: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
                marketing: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0L21.3 15.3z"></path><path d="M7.5 10.5L14 17"></path></svg>`,
                sales: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
                leadership: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M2 20h20M5 20V9l7-5 7 5v11M9 20v-6h6v6"></path></svg>`
            };

            performancePacks.forEach(pack => {
                const isActive = performanceData.activePacks.includes(pack.id);
                
                const packItem = document.createElement('div');
                packItem.className = 'setting-item';
                packItem.style.cursor = 'pointer';
                
                packItem.innerHTML = `
                    <div>
                        <div class="setting-label" style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">${pack.icon}</span>
                            <span>${pack.name}</span>
                        </div>
                        <div class="setting-description">${pack.description}</div>
                        <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                            ${pack.categories.map(cat => `
                                <span style="
                                    padding: 2px 8px;
                                    background: var(--bg-elevated);
                                    border: 1px solid var(--border);
                                    border-radius: 4px;
                                    font-size: 10px;
                                    font-weight: 600;
                                    color: var(--text-secondary);
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 4px;
                                ">${packCategoryIcons[cat.id] || ''} ${cat.name}</span>
                            `).join('')}
                        </div>
                    </div>
                    <div style="display: flex; justify-content: center; margin-top: 14px;">
                        <div class="toggle-switch ${isActive ? 'active' : ''}" id="packToggle_${pack.id}">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                `;

                const toggle = packItem.querySelector('.toggle-switch');
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePerformancePack(pack.id);
                });

                listContainer.appendChild(packItem);
            });
        }

        function renderPerformancePacks() {
            const container = document.getElementById('performancePacksContainer');
            const listContainer = document.getElementById('performancePacksList');

            if (!isPro) {
                container.style.display = 'none';
                return;
            }

            const activePacks = performanceData.activePacks || [];
            
            if (activePacks.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            listContainer.innerHTML = '';

            // Render each active pack like FYS-Index
            activePacks.forEach(packId => {
                const pack = performancePacks.find(p => p.id === packId);
                if (!pack) return;
                
                // Get current pack index value
                let packIndexValue = 100.0;
                let changeValue = 0;
                let changePercent = 0;
                
                if (performanceData.entries.length > 0) {
                    const lastEntry = performanceData.entries[performanceData.entries.length - 1];
                    packIndexValue = lastEntry.packIndices?.[pack.id] || 100.0;
                    
                    if (performanceData.entries.length > 1) {
                        const prevEntry = performanceData.entries[performanceData.entries.length - 2];
                        const prevValue = prevEntry.packIndices?.[pack.id] || 100.0;
                        changeValue = packIndexValue - prevValue;
                        changePercent = (changeValue / prevValue) * 100;
                    }
                }

                // Create main chart section like FYS Index
                const packSection = document.createElement('div');
                packSection.className = 'main-chart-section';
                packSection.style.marginBottom = '20px';
                packSection.onclick = () => openPackDetails(pack.id);
                
                packSection.innerHTML = `
                    <div class="main-chart-container">
                        <canvas id="packChart_${pack.id}"></canvas>
                    </div>
                    <div class="index-value-display">
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; justify-content: center;">
                            <span style="font-size: 20px;">${pack.icon}</span>
                            <span>${pack.name}</span>
                        </div>
                        <div class="index-value-number" style="color: ${changeValue >= 0 ? 'var(--accent-up)' : 'var(--accent-down)'};">${packIndexValue.toFixed(1)}</div>
                        <div class="index-change-text" style="color: ${changeValue >= 0 ? 'var(--accent-up)' : 'var(--accent-down)'};">
                            ${changeValue >= 0 ? '▲' : '▼'} ${Math.abs(changeValue).toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)
                        </div>
                    </div>
                    <div class="tap-hint">Tippen für Details</div>
                `;

                listContainer.appendChild(packSection);

                // Create chart after DOM insertion
                setTimeout(() => {
                    createPackMiniChart(pack.id);
                }, 100);
            });
        }

        function createPackMiniChart(packId) {
            const canvas = document.getElementById(`packChart_${packId}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (window[`packMiniChart_${packId}`]) {
                window[`packMiniChart_${packId}`].destroy();
            }

            // Use SAME time range as FYS Index (synchronized)
            const entries = getFilteredEntries(); // Uses currentTimeRange!
            
            // Filter for entries with pack data
            const packEntries = entries.filter(e => 
                e.packIndices && e.packIndices[packId] !== undefined
            );

            const labels = packEntries.map(e => {
                const date = new Date(e.date);
                const day = date.getDate();
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            });

            const data = packEntries.map(e => e.packIndices[packId]);

            // 1:1 COPY of FYS Index Chart Config!
            window[`packMiniChart_${packId}`] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: packId,
                        data: data,
                        borderColor: '#ff6b35', // Same as FYS Index
                        backgroundColor: 'rgba(255, 107, 53, 0.1)', // Same as FYS Index
                        borderWidth: 3, // Same as FYS Index
                        tension: 0.4, // Same as FYS Index
                        pointRadius: 0, // Same as FYS Index
                        pointHoverRadius: 6, // Same as FYS Index
                        fill: true // Same as FYS Index
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Same as FYS Index
                    interaction: { mode: 'index', intersect: false }, // Same as FYS Index
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: currentTheme === 'dark' ? 'rgba(17, 17, 17, 0.95)' : 'rgba(255, 255, 255, 0.98)',
                            titleColor: currentTheme === 'dark' ? '#ffffff' : '#ff6b35',
                            bodyColor: currentTheme === 'dark' ? '#6b6b6b' : '#ff8f5f',
                            borderColor: currentTheme === 'dark' ? '#1a1a1a' : '#ffe8e0',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return context[0].parsed.y.toFixed(1);
                                },
                                label: function(context) {
                                    return context.label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { display: false }
                        },
                        y: {
                            // 1:1 SAME as FYS Index!
                            beginAtZero: false,
                            grace: '5%', // 5% Padding oben und unten
                            grid: { 
                                color: currentTheme === 'dark' ? '#1a1a1a' : '#fff5f0', 
                                drawBorder: false 
                            },
                            ticks: { 
                                color: currentTheme === 'dark' ? '#404040' : '#ff8f5f', 
                                font: { size: 10 },
                                padding: 5
                            }
                        }
                    }
                }
            });
        }

        // Performance Pack Detail Views
        function openPackDetails(packId) {
            const pack = performancePacks.find(p => p.id === packId);
            if (!pack) return;
            
            if (!performanceData.activePacks.includes(packId)) {
                alert('Bitte aktiviere zuerst dieses Performance Pack um Details zu sehen.');
                return;
            }
            
            // Open chartDetailsView (same as FYS Index)
            const homeView = safeGetElement('homeView');
            const detailsView = safeGetElement('chartDetailsView');
            if (homeView) homeView.classList.remove('active');
            if (detailsView) detailsView.classList.add('active');
            
            // Update FYS-INDEX label to PACK NAME
            const indexLabel = document.querySelector('#chartDetailsView .fys-index-label');
            if (indexLabel) {
                indexLabel.textContent = pack.name.toUpperCase();
            }
            
            // Update index summary
            let currentValue = 100;
            let changeValue = 0;
            let changePercent = 0;
            
            if (performanceData.entries.length > 0) {
                const lastEntry = performanceData.entries[performanceData.entries.length - 1];
                currentValue = lastEntry.packIndices?.[packId] || 100;
                
                if (performanceData.entries.length > 1) {
                    const firstEntry = performanceData.entries[0];
                    const firstValue = firstEntry.packIndices?.[packId] || 100;
                    changeValue = currentValue - firstValue;
                    changePercent = ((changeValue / firstValue) * 100);
                }
            }
            
            const indexValueEl = safeGetElement('detailIndexValue');
            const indexChangeEl = safeGetElement('detailIndexChange');
            if (indexValueEl) indexValueEl.textContent = currentValue.toFixed(1);
            if (indexChangeEl) indexChangeEl.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
            
            // Create stock list for pack categories (with CONSISTENT ICONS)
            createPackStockList(pack);
            
            // Update combined chart with pack data
            updatePackCombinedChart(packId);
            
            // Render values table (like FYS Index)
            setTimeout(() => renderPackValuesTable(packId), 200);
        }

        function renderPackValuesTable(packId) {
            // Find or create table container
            let tableContainer = document.getElementById('packValuesTableContainer');
            
            if (!tableContainer) {
                // Insert after combined chart
                const chartCard = document.querySelector('#chartDetailsView .chart-card');
                if (chartCard) {
                    tableContainer = document.createElement('div');
                    tableContainer.id = 'packValuesTableContainer';
                    tableContainer.className = 'chart-card';
                    tableContainer.style.marginTop = '16px';
                    chartCard.parentNode.insertBefore(tableContainer, chartCard.nextSibling);
                }
            }
            
            if (!tableContainer) return;

            const entries = getFilteredEntries().filter(e => e.packIndices && e.packIndices[packId] !== undefined);
            
            if (entries.length === 0) {
                tableContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Keine Daten verfügbar</div>';
                return;
            }

            // Reverse to show newest first
            const reversedEntries = [...entries].reverse();

            let tableHTML = `
                <div style="max-height: 300px; overflow-y: auto;">
                    <table style="width: 100%; font-size: 13px;">
                        <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th style="text-align: left; padding: 12px 8px; color: var(--text-secondary); font-weight: 600;">Datum</th>
                                <th style="text-align: right; padding: 12px 8px; color: var(--text-secondary); font-weight: 600;">Wert</th>
                                <th style="text-align: right; padding: 12px 8px; color: var(--text-secondary); font-weight: 600;">Änderung</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            reversedEntries.forEach((entry, index) => {
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const value = entry.packIndices[packId];
                
                let change = 0;
                let changePercent = 0;
                
                if (index < reversedEntries.length - 1) {
                    const prevEntry = reversedEntries[index + 1];
                    const prevValue = prevEntry.packIndices[packId];
                    change = value - prevValue;
                    changePercent = (change / prevValue) * 100;
                }

                const changeColor = change > 0 ? 'var(--accent-up)' : change < 0 ? 'var(--accent-down)' : 'var(--text-secondary)';
                const changeSymbol = change > 0 ? '▲' : change < 0 ? '▼' : '—';

                tableHTML += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px 8px; color: var(--text-primary);">${dateStr}</td>
                        <td style="text-align: right; padding: 12px 8px; color: var(--text-primary); font-weight: 600;">${value.toFixed(1)}</td>
                        <td style="text-align: right; padding: 12px 8px; color: ${changeColor}; font-weight: 600;">
                            ${changeSymbol} ${Math.abs(changePercent).toFixed(2)}%
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            tableContainer.innerHTML = tableHTML;
        }

        function createPackStockList(pack) {
            const container = document.getElementById('stockListItems');
            if (!container) return;
            
            container.innerHTML = '';

            const entries = getFilteredEntries();
            
            // SVG Icons for pack categories
            const packCategoryIcons = {
                // Finance Pack
                savings: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>`,
                investments: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>`,
                budget: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 18V6"></path></svg>`,
                income: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12H4M20 12l-4-4M20 12l-4 4"></path></svg>`,
                financial_education: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
                
                // Health Pack
                cardio: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>`,
                strength: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 6.5v11M17.5 6.5v11M3 9.5h3M18 9.5h3M3 14.5h3M18 14.5h3M9 3v3M15 3v3M9 18v3M15 18v3"></path></svg>`,
                flexibility: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path></svg>`,
                mental_health: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 14 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>`,
                
                // Entrepreneurship Pack
                networking: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
                product_development: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
                marketing: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0L21.3 15.3z"></path><path d="M7.5 10.5L14 17"></path></svg>`,
                sales: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
                leadership: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20h20M5 20V9l7-5 7 5v11M9 20v-6h6v6"></path></svg>`
            };

            pack.categories.forEach(cat => {
                let currentValue = 100;
                let changeValue = 0;
                let changePercent = 0;

                if (entries.length > 0) {
                    const lastEntry = entries[entries.length - 1];
                    currentValue = lastEntry.categoryValues?.[cat.id] || 100;

                    if (entries.length > 1) {
                        const firstEntry = entries[0];
                        const firstValue = firstEntry.categoryValues?.[cat.id] || 100;
                        changeValue = currentValue - firstValue;
                        changePercent = ((changeValue / firstValue) * 100);
                    }
                }

                const stockItem = document.createElement('div');
                stockItem.className = 'stock-item';
                stockItem.onclick = () => openPackCategoryDetail(pack.id, cat.id);
                stockItem.style.cursor = 'pointer';
                
                stockItem.innerHTML = `
                    <div class="stock-item-left">
                        <div class="stock-icon" style="background: ${cat.color}20; color: ${cat.color};">
                            ${packCategoryIcons[cat.id] || cat.emoji}
                        </div>
                        <div class="stock-info">
                            <div class="stock-name">${cat.name}</div>
                            <div class="stock-symbol">${cat.id.toUpperCase()}</div>
                        </div>
                    </div>
                    <div class="stock-item-right">
                        <div class="stock-price">${currentValue.toFixed(1)}</div>
                        <div class="stock-change ${changeValue >= 0 ? 'positive' : changeValue < 0 ? 'negative' : 'neutral'}">
                            <span class="stock-arrow">${changeValue >= 0 ? '▲' : changeValue < 0 ? '▼' : '—'}</span>
                            ${Math.abs(changePercent).toFixed(1)}%
                        </div>
                    </div>
                `;
                
                container.appendChild(stockItem);
            });
        }

        function updatePackCombinedChart(packId) {
            const canvas = document.getElementById('combinedChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            if (combinedChart) {
                combinedChart.destroy();
            }

            const entries = getFilteredEntries();
            if (entries.length === 0) {
                combinedChart = null;
                return;
            }

            const pack = performancePacks.find(p => p.id === packId);
            if (!pack) return;

            const labels = entries.map(e => {
                const d = new Date(e.date);
                return d.toLocaleDateString('de-DE', { month: 'short', day: 'numeric' });
            });

            // Create datasets for all pack categories
            const datasets = pack.categories.map(cat => {
                const data = entries.map(e => e.categoryValues?.[cat.id] || 100);
                
                return {
                    label: cat.name,
                    data: data,
                    borderColor: cat.color,
                    backgroundColor: `${cat.color}10`,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    borderWidth: 2
                };
            });

            combinedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#666',
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#666', maxTicksLimit: 6 }
                        },
                        y: {
                            grid: { color: '#1a1a1a' },
                            ticks: { color: '#666' }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function openPackCategoryDetail(packId, categoryId) {
            const pack = performancePacks.find(p => p.id === packId);
            if (!pack) return;
            
            const category = pack.categories.find(c => c.id === categoryId);
            if (!category) return;
            
            if (!performanceData.activePacks.includes(packId)) {
                alert('Bitte aktiviere zuerst dieses Performance Pack um Details zu sehen.');
                return;
            }
            
            // Use EXACT SAME LAYOUT as FYS Index category details
            const modal = safeGetElement('categoryDetailModal');
            const header = safeGetElement('categoryDetailHeader');
            const content = safeGetElement('categoryDetailContent');
            
            if (!modal || !header || !content) return;
            
            // Get icon HTML (same as FYS Index)
            const iconHtml = categoryIcons[categoryId] || `<div style="font-size: 24px;">${category.emoji}</div>`;
            
            // IDENTICAL HEADER STRUCTURE TO FYS INDEX
            header.innerHTML = `
                <div class="category-detail-icon" style="background: ${category.color}20; color: ${category.color};">
                    ${iconHtml}
                </div>
                <div class="category-detail-info">
                    <div class="category-detail-name">${category.name}</div>
                    <div class="category-detail-symbol" style="display: flex; align-items: center; gap: 6px;">
                        <span style="color: var(--text-secondary); font-size: 12px;">${pack.name}</span>
                        <span style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; padding: 2px 5px; border-radius: 3px; font-size: 8px; font-weight: 800; letter-spacing: 0.5px;">PRO</span>
                    </div>
                </div>
                <button class="close-btn" onclick="closeCategoryDetail()">×</button>
            `;
            
            // Get data (same calculation as FYS Index)
            const entries = getFilteredEntries();
            let currentValue = 100;
            let changeValue = 0;
            let changePercent = 0;
            
            if (entries.length > 0) {
                const lastEntry = entries[entries.length - 1];
                currentValue = lastEntry.categoryValues?.[categoryId] || 100;
                
                if (entries.length > 1) {
                    const firstEntry = entries[0];
                    const firstValue = firstEntry.categoryValues?.[categoryId] || 100;
                    changeValue = currentValue - firstValue;
                    changePercent = (changeValue / firstValue) * 100;
                }
            }
            
            // IDENTICAL CONTENT STRUCTURE TO FYS INDEX
            content.innerHTML = `
                <div class="category-detail-price-section">
                    <div class="category-detail-price" style="color: ${changeValue >= 0 ? 'var(--accent-up)' : 'var(--accent-down)'};">${currentValue.toFixed(1)}</div>
                    <div class="category-detail-change" style="background: ${changeValue >= 0 ? 'rgba(0, 255, 136, 0.1)' : 'rgba(255, 51, 102, 0.1)'}; color: ${changeValue >= 0 ? 'var(--accent-up)' : 'var(--accent-down)'};">
                        ${changeValue >= 0 ? '▲' : '▼'} ${Math.abs(changePercent).toFixed(2)}%
                    </div>
                </div>
                
                <div class="category-time-selector">
                    <button class="category-time-btn active" onclick="changePackCategoryTimeRange('${categoryId}', '1d')" data-range="1d">1D</button>
                    <button class="category-time-btn" onclick="changePackCategoryTimeRange('${categoryId}', '7d')" data-range="7d">7D</button>
                    <button class="category-time-btn" onclick="changePackCategoryTimeRange('${categoryId}', '1m')" data-range="1m">1M</button>
                    <button class="category-time-btn" onclick="changePackCategoryTimeRange('${categoryId}', '6m')" data-range="6m">6M</button>
                    <button class="category-time-btn" onclick="changePackCategoryTimeRange('${categoryId}', '1y')" data-range="1y">1Y</button>
                    <button class="category-time-btn" onclick="changePackCategoryTimeRange('${categoryId}', 'all')" data-range="all">MAX</button>
                </div>
                
                <div class="category-chart-card">
                    <div class="category-chart-container">
                        <canvas id="packCategoryDetailChart"></canvas>
                    </div>
                </div>
                
                <div class="category-chart-card" style="margin-top: 16px;">
                    <div id="packCategoryValuesTable"></div>
                </div>
            `;
            
            modal.classList.add('active');
            
            setTimeout(() => {
                createPackCategoryDetailChart(categoryId, 'all');
                renderPackCategoryValuesTable(categoryId);
            }, 100);
        }

        function renderPackCategoryValuesTable(categoryId) {
            const container = document.getElementById('packCategoryValuesTable');
            if (!container) return;

            const entries = getFilteredEntries().filter(e => e.categoryValues && e.categoryValues[categoryId] !== undefined);
            
            if (entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Keine Daten verfügbar</div>';
                return;
            }

            // Reverse to show newest first
            const reversedEntries = [...entries].reverse();

            let tableHTML = `
                <div style="max-height: 300px; overflow-y: auto;">
                    <table style="width: 100%; font-size: 13px;">
                        <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th style="text-align: left; padding: 12px 8px; color: var(--text-secondary); font-weight: 600;">Datum</th>
                                <th style="text-align: right; padding: 12px 8px; color: var(--text-secondary); font-weight: 600;">Wert</th>
                                <th style="text-align: right; padding: 12px 8px; color: var(--text-secondary); font-weight: 600;">Änderung</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            reversedEntries.forEach((entry, index) => {
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const value = entry.categoryValues[categoryId];
                
                let change = 0;
                let changePercent = 0;
                
                if (index < reversedEntries.length - 1) {
                    const prevEntry = reversedEntries[index + 1];
                    const prevValue = prevEntry.categoryValues[categoryId];
                    change = value - prevValue;
                    changePercent = (change / prevValue) * 100;
                }

                const changeColor = change > 0 ? 'var(--accent-up)' : change < 0 ? 'var(--accent-down)' : 'var(--text-secondary)';
                const changeSymbol = change > 0 ? '▲' : change < 0 ? '▼' : '—';

                tableHTML += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px 8px; color: var(--text-primary);">${dateStr}</td>
                        <td style="text-align: right; padding: 12px 8px; color: var(--text-primary); font-weight: 600;">${value.toFixed(1)}</td>
                        <td style="text-align: right; padding: 12px 8px; color: ${changeColor}; font-weight: 600;">
                            ${changeSymbol} ${Math.abs(changePercent).toFixed(2)}%
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        function createPackDetailChart(packId, timeRange) {
            const canvas = document.getElementById('packDetailChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (window.currentPackDetailChart) window.currentPackDetailChart.destroy();
            
            let entries = performanceData.entries.filter(e => e.packIndices && e.packIndices[packId] !== undefined);
            
            const now = new Date();
            if (timeRange !== 'all') {
                const ranges = { '1d': 1, '7d': 7, '1m': 30, '6m': 180, '1y': 365 };
                const days = ranges[timeRange];
                const cutoff = new Date(now);
                cutoff.setDate(cutoff.getDate() - days);
                entries = entries.filter(e => new Date(e.date) >= cutoff);
            }
            
            const labels = entries.map(e => new Date(e.date).toLocaleDateString('de-DE', { month: 'short', day: 'numeric' }));
            const data = entries.map(e => e.packIndices[packId]);
            
            window.currentPackDetailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pack Index',
                        data: data,
                        borderColor: '#ff6b35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#666' } },
                        y: { grid: { color: '#1a1a1a' }, ticks: { color: '#666' } }
                    }
                }
            });
        }

        function createPackCategoryDetailChart(categoryId, timeRange) {
            const canvas = document.getElementById('packCategoryDetailChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (window.currentPackCategoryDetailChart) window.currentPackCategoryDetailChart.destroy();
            
            let entries = performanceData.entries.filter(e => e.categoryValues && e.categoryValues[categoryId] !== undefined);
            
            const now = new Date();
            if (timeRange !== 'all') {
                const ranges = { '1d': 1, '7d': 7, '1m': 30, '6m': 180, '1y': 365 };
                const days = ranges[timeRange];
                const cutoff = new Date(now);
                cutoff.setDate(cutoff.getDate() - days);
                entries = entries.filter(e => new Date(e.date) >= cutoff);
            }
            
            // Find category color
            let categoryColor = '#ff6b35';
            performancePacks.forEach(pack => {
                const cat = pack.categories.find(c => c.id === categoryId);
                if (cat) categoryColor = cat.color;
            });
            
            const labels = entries.map(e => new Date(e.date).toLocaleDateString('de-DE', { month: 'short', day: 'numeric' }));
            const data = entries.map(e => e.categoryValues[categoryId]);
            
            window.currentPackCategoryDetailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Category Value',
                        data: data,
                        borderColor: categoryColor,
                        backgroundColor: `${categoryColor}20`,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#666' } },
                        y: { grid: { color: '#1a1a1a' }, ticks: { color: '#666' } }
                    }
                }
            });
        }

        function changePackCategoryTimeRange(categoryId, range) {
            document.querySelectorAll('.category-time-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === range);
            });
            createPackCategoryDetailChart(categoryId, range);
        }

        function updateUI() {
            const t = translations[currentLang];
            
            // Helper function for safe updates
            const safeUpdate = (id, content, isPlaceholder = false) => {
                const el = document.getElementById(id);
                if (el) {
                    if (isPlaceholder) {
                        el.placeholder = content;
                    } else {
                        el.textContent = content;
                    }
                }
            };
            
            updateHeaderDate();
            
            // Update Check-in Widget with correct question count
            const totalQuestions = baseWizardCategories.length + (isPro ? getActivePackCategories().length : 0);
            safeUpdate('checkinWidgetSubtitle', `Beantworte ${totalQuestions} Fragen zu deinem Tag`);
            
            safeUpdate('tapHint', t.tapHint);
            safeUpdate('backText', t.backText);
            safeUpdate('allCategoriesTitle', t.allCategoriesTitle);
            safeUpdate('checkinTitle', t.checkinTitle);
            safeUpdate('taskWidgetTitle', t.taskWidgetTitle);
            safeUpdate('comingSoonBadge', t.comingSoonBadge);
            safeUpdate('habitsTitle', t.habitsTitle);
            safeUpdate('soberTitle', t.soberTitle);
            safeUpdate('habitWidgetTitle', t.habitWidgetTitle);
            safeUpdate('habitStreakLabel', t.habitStreakLabel);
            safeUpdate('habitTodayLabel', t.habitTodayLabel);
            safeUpdate('soberWidgetTitle', t.soberWidgetTitle);
            safeUpdate('soberDaysLabel', t.soberDaysLabel);
            safeUpdate('soberStreakLabel', t.soberStreakLabel);
            safeUpdate('habitComingTitle', t.habitComingTitle);
            safeUpdate('habitComingText', t.habitComingText);
            safeUpdate('soberComingTitle', t.soberComingTitle);
            safeUpdate('soberComingText', t.soberComingText);
            safeUpdate('settingsTitle', t.settingsTitle);
            safeUpdate('languageLabel', t.languageLabel);
            safeUpdate('languageDesc', t.languageDesc);
            safeUpdate('themeLabel', t.themeLabel);
            safeUpdate('themeDesc', t.themeDesc);
            safeUpdate('darkTheme', t.darkTheme);
            safeUpdate('lightTheme', t.lightTheme);
            safeUpdate('sleepGoalLabel', t.sleepGoalLabel);
            safeUpdate('sleepGoalDesc', t.sleepGoalDesc);
            safeUpdate('coachDataLabel', t.coachDataLabel);
            safeUpdate('coachDataDesc', t.coachDataDesc);
            safeUpdate('navHome', t.navHome);
            safeUpdate('navCheckin', t.navCheckin);
            safeUpdate('navCoach', t.navCoach);
            safeUpdate('navSettings', t.navSettings);
            safeUpdate('coachTitle', t.coachTitle);
            safeUpdate('coachInput', t.coachPlaceholder, true);
            safeUpdate('sleepGoalValue', sleepGoal.toFixed(1) + 'h');
            
            // Update Pro button state
            updateProButton();
            
            updateCheckinView();
            renderPerformancePacks(); // Render active pack cards
        }

        // Switch view with haptic feedback
        function switchView(view) {
            // Haptic Feedback (iOS-Style)
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(10); // Light haptic
            }
            
            // Close all modals
            document.getElementById('coachModal').classList.remove('active');
            document.getElementById('categoryDetailModal').classList.remove('active');
            document.getElementById('journalModal').classList.remove('active');
            
            // Wenn Start-Button und schon auf Home: Scroll to top
            if (view === 'home' && document.getElementById('homeView').classList.contains('active')) {
                // Bereits auf Home - scroll to top
                document.getElementById('homeView').scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }
            
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));

            document.getElementById(`${view}View`).classList.add('active');
            const navItem = document.querySelector(`[data-view="${view}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
            
            if (view === 'checkin') {
                console.log('🔧 CHECK-IN VIEW ACTIVATED');
                
                try {
                    // Update wizard subtitle with correct number of questions
                    const totalQuestions = baseWizardCategories.length + (isPro ? getActivePackCategories().length : 0);
                    console.log('  ✓ Total questions:', totalQuestions);
                    
                    const subtitle = document.getElementById('wizardConfirmSubtitle');
                    if (subtitle) {
                        subtitle.textContent = `Beantworte ${totalQuestions} kurze Fragen zu deinem Tag`;
                        console.log('  ✓ Subtitle updated');
                    }
                    
                    // Hide error and wizard container
                    const errorDiv = document.getElementById('wizardError');
                    const container = document.getElementById('wizardContainer');
                    if (errorDiv) errorDiv.classList.remove('active');
                    if (container) container.classList.remove('active');
                    
                    // Show wizard confirmation dialog
                    const confirmDialog = document.getElementById('wizardConfirm');
                    if (confirmDialog) {
                        confirmDialog.classList.add('active');
                        console.log('  ✓ Confirm dialog shown');
                    } else {
                        console.error('  ✗ wizardConfirm element not found!');
                        throw new Error('wizardConfirm element not found');
                    }
                } catch (error) {
                    console.error('  ✗ Error showing check-in:', error);
                    showWizardError();
                }
            }
        }

        // Switch to Coach with tab activation
        function switchToCoach() {
            // Haptic Feedback
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(10);
            }
            
            // Deactivate all tabs
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            
            // Activate coach tab
            const coachTab = document.querySelector('[data-view="coach"]');
            if (coachTab) {
                coachTab.classList.add('active');
            }
            
            // Open coach modal
            openCoach();
        }

        // Coach functions
        function openCoach() {
            const modal = document.getElementById('coachModal');
            const content = document.getElementById('coachContent');
            const t = translations[currentLang];
            
            if (content.children.length === 0) {
                content.innerHTML = `
                    <div class="message assistant">
                        <div class="message-bubble">${t.coachWelcome}</div>
                    </div>
                `;
            }
            
            modal.classList.add('active');
        }

        function closeCoach() {
            document.getElementById('coachModal').classList.remove('active');
            
            // Deactivate coach tab when closing
            document.querySelector('[data-view="coach"]').classList.remove('active');
        }

        async function sendMessage() {
            const input = document.getElementById('coachInput');
            const message = input.value.trim();
            
            if (!message) return;

            const content = document.getElementById('coachContent');
            const sendBtn = document.getElementById('sendBtn');

            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.innerHTML = `<div class="message-bubble">${message}</div>`;
            content.appendChild(userMsg);
            content.scrollTop = content.scrollHeight;

            input.value = '';
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loading"></div>';

            let context = '';
            if (coachDataAccess && performanceData.entries.length > 0) {
                const latest = performanceData.entries[performanceData.entries.length - 1];
                const t = translations[currentLang];
                context = `Values: ${categories.map(cat => 
                    `${t.categories[cat.id]}: ${latest.values[cat.id] || 10}`).join(', ')}. Sleep: ${latest.sleepHours}h. FYS: ${latest.fysIndex.toFixed(1)}. `;
            }

            try {
                const systemPrompts = {
                    de: `Du bist FYS Coach. ${context}Kurz (max 3 Sätze).`,
                    en: `You are FYS coach. ${context}Brief (max 3 sentences).`,
                    es: `Eres coach FYS. ${context}Breve (máx 3 frases).`
                };

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        system: systemPrompts[currentLang],
                        messages: [{ role: "user", content: message }]
                    })
                });

                const data = await response.json();
                const assistantText = data.content.filter(b => b.type === "text").map(b => b.text).join("\n");

                const assistantMsg = document.createElement('div');
                assistantMsg.className = 'message assistant';
                assistantMsg.innerHTML = `<div class="message-bubble">${assistantText}</div>`;
                content.appendChild(assistantMsg);
                content.scrollTop = content.scrollHeight;

            } catch (error) {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'message assistant';
                errorMsg.innerHTML = `<div class="message-bubble">Technical issue!</div>`;
                content.appendChild(errorMsg);
            }

            sendBtn.disabled = false;
            sendBtn.innerHTML = '➤';
        }

        // Journal Functions
        let journalData = JSON.parse(localStorage.getItem('fysJournal')) || {};
        let currentJournalMonth = new Date();
        let selectedJournalDate = null;

        function openJournal() {
            document.getElementById('journalModal').classList.add('active');
            currentJournalMonth = new Date();
            renderCalendar();
            updateJournalStats();
        }

        function closeJournal() {
            document.getElementById('journalModal').classList.remove('active');
            document.getElementById('journalEntrySection').classList.remove('active');
        }

        function openTaskManager() {
            alert('✓ Task Manager\n\nDiese Funktion wird gerade entwickelt und ist bald verfügbar!');
        }

        function openHabitTracker() {
            alert('🎯 Habit Tracker\n\nDiese Funktion wird gerade entwickelt und ist bald verfügbar!');
        }

        function openSoberTracker() {
            alert('🌟 Sober Tracker\n\nDiese Funktion wird gerade entwickelt und ist bald verfügbar!');
        }

        function changeMonth(delta) {
            currentJournalMonth.setMonth(currentJournalMonth.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 
                              'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            
            document.getElementById('calendarMonth').textContent = 
                `${monthNames[currentJournalMonth.getMonth()]} ${currentJournalMonth.getFullYear()}`;

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // Day headers
            const dayHeaders = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Get first day and number of days
            const firstDay = new Date(currentJournalMonth.getFullYear(), currentJournalMonth.getMonth(), 1);
            const lastDay = new Date(currentJournalMonth.getFullYear(), currentJournalMonth.getMonth() + 1, 0);
            const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Monday = 0

            // Empty cells
            for (let i = 0; i < startDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty';
                grid.appendChild(empty);
            }

            // Day cells
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;

                const dateKey = `${currentJournalMonth.getFullYear()}-${currentJournalMonth.getMonth() + 1}-${day}`;
                
                // Check if today
                if (currentJournalMonth.getFullYear() === today.getFullYear() &&
                    currentJournalMonth.getMonth() === today.getMonth() &&
                    day === today.getDate()) {
                    dayEl.classList.add('today');
                }

                // Check if has entry
                if (journalData[dateKey]) {
                    dayEl.classList.add('has-entry');
                }

                dayEl.onclick = () => selectDate(day);
                grid.appendChild(dayEl);
            }
        }

        function selectDate(day) {
            selectedJournalDate = `${currentJournalMonth.getFullYear()}-${currentJournalMonth.getMonth() + 1}-${day}`;
            
            const dateObj = new Date(currentJournalMonth.getFullYear(), currentJournalMonth.getMonth(), day);
            const dateStr = `${day}. ${['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 
                                        'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'][dateObj.getMonth()]} ${dateObj.getFullYear()}`;
            
            document.getElementById('journalEntryDate').textContent = dateStr;
            document.getElementById('journalTextarea').value = journalData[selectedJournalDate] || '';
            document.getElementById('journalEntrySection').classList.add('active');
        }

        function saveJournalEntry() {
            const text = document.getElementById('journalTextarea').value;
            
            if (text.trim()) {
                journalData[selectedJournalDate] = text;
            } else {
                delete journalData[selectedJournalDate];
            }
            
            localStorage.setItem('fysJournal', JSON.stringify(journalData));
            showToast();
            renderCalendar();
            updateJournalStats();
        }

        function updateJournalStats() {
            const entries = Object.keys(journalData).length;
            document.getElementById('journalEntriesCount').textContent = entries;

            if (entries > 0) {
                const dates = Object.keys(journalData).sort().reverse();
                const lastDate = dates[0].split('-');
                document.getElementById('journalLastDate').textContent = 
                    `${lastDate[2]}.${lastDate[1]}`;
            } else {
                document.getElementById('journalLastDate').textContent = '—';
            }
        }

        // ========================================
        // WIZARD CHECK-IN FUNCTIONS
        // ========================================
        
        const baseWizardCategories = [
            { id: 'social', name: { de: 'Soziales', en: 'Social', es: 'Social' }, color: '#ffd700', hint: { de: 'Wie war die Qualität deiner sozialen Interaktionen?', en: 'How was the quality of your social interactions?', es: '¿Cómo fue la calidad de tus interacciones sociales?' } },
            { id: 'energy', name: { de: 'Energie', en: 'Energy', es: 'Energía' }, color: '#00ff88', hint: { de: 'Wie viel Energie hattest du heute?', en: 'How much energy did you have today?', es: '¿Cuánta energía tuviste hoy?' } },
            { id: 'sleep', name: { de: 'Schlaf', en: 'Sleep', es: 'Sueño' }, color: '#00ff88', hint: { de: 'Wie viele Stunden hast du geschlafen?', en: 'How many hours did you sleep?', es: '¿Cuántas horas dormiste?' }, isSleep: true },
            { id: 'focus', name: { de: 'Fokus', en: 'Focus', es: 'Enfoque' }, color: '#ff6b35', hint: { de: 'Wie gut konntest du dich konzentrieren?', en: 'How well could you concentrate?', es: '¿Qué tan bien pudiste concentrarte?' } },
            { id: 'discipline', name: { de: 'Disziplin', en: 'Discipline', es: 'Disciplina' }, color: '#a8a8a8', hint: { de: 'Wie diszipliniert warst du heute?', en: 'How disciplined were you today?', es: '¿Qué tan disciplinado fuiste hoy?' } },
            { id: 'sport', name: { de: 'Sport', en: 'Sport', es: 'Deporte' }, color: '#ff4757', hint: { de: 'Wie aktiv warst du körperlich?', en: 'How physically active were you?', es: '¿Qué tan activo estuviste físicamente?' } },
            { id: 'nutrition', name: { de: 'Ernährung', en: 'Nutrition', es: 'Nutrición' }, color: '#00d4ff', hint: { de: 'Wie gesund hast du dich ernährt?', en: 'How healthy did you eat?', es: '¿Qué tan saludable comiste?' } },
            { id: 'mindset', name: { de: 'Mindset', en: 'Mindset', es: 'Mentalidad' }, color: '#5f7aff', hint: { de: 'Wie positiv war deine Einstellung?', en: 'How positive was your attitude?', es: '¿Qué tan positiva fue tu actitud?' } }
        ];

        // Function to get wizard categories including active pack categories
        function getWizardCategories() {
            let wizardCats = [...baseWizardCategories];
            
            try {
                // Add active pack categories
                if (isPro && performanceData.activePacks && performanceData.activePacks.length > 0) {
                    console.log('Adding pack categories:', performanceData.activePacks);
                    const packCats = getActivePackCategories();
                    
                    if (packCats && packCats.length > 0) {
                        packCats.forEach(packCat => {
                            if (packCat && packCat.id && packCat.name && packCat.color) {
                                wizardCats.push({
                                    id: packCat.id,
                                    name: { de: packCat.name, en: packCat.name, es: packCat.name },
                                    color: packCat.color,
                                    hint: { 
                                        de: `Wie würdest du dein ${packCat.name} heute bewerten?`, 
                                        en: `How would you rate your ${packCat.name} today?`, 
                                        es: `¿Cómo calificarías tu ${packCat.name} hoy?` 
                                    }
                                });
                                
                                // Add icon for pack category
                                if (!categoryIcons[packCat.id] && packCat.emoji) {
                                    categoryIcons[packCat.id] = `<div style="font-size: 20px;">${packCat.emoji}</div>`;
                                }
                            }
                        });
                        console.log('✓ Added', packCats.length, 'pack categories');
                    }
                }
            } catch (error) {
                console.error('Error adding pack categories:', error);
                console.error('Falling back to base categories only');
            }
            
            return wizardCats;
        }

        const categoryIcons = {
            // Base categories
            social: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
            energy: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
            sleep: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
            focus: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`,
            discipline: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
            sport: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>`,
            nutrition: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>`,
            mindset: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>`,
            
            // Finance Pack
            savings: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>`,
            investments: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>`,
            budget: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 18V6"></path></svg>`,
            income: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>`,
            financial_education: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
            
            // Health Pack
            cardio: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>`,
            strength: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 6.5v11M17.5 6.5v11M3 9.5h3M18 9.5h3M3 14.5h3M18 14.5h3M9 3v3M15 3v3M9 18v3M15 18v3"></path></svg>`,
            flexibility: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path></svg>`,
            mental_health: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 14 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>`,
            
            // Entrepreneurship Pack
            networking: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
            product_development: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>`,
            marketing: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0L21.3 15.3z"></path><path d="M7.5 10.5L14 17"></path></svg>`,
            sales: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
            leadership: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20h20M5 20V9l7-5 7 5v11M9 20v-6h6v6"></path></svg>`
        };

        let wizardCurrentStep = 0;
        let wizardDraft = {};
        let wizardCategories = []; // Will be populated in startWizard

        function startWizard() {
            console.log('╔════════════════════════════════════╗');
            console.log('║   START WIZARD - DEBUG MODE        ║');
            console.log('╚════════════════════════════════════╝');
            
            try {
                // Step 1: Get categories
                wizardCategories = getWizardCategories();
                console.log('✓ Categories loaded:', wizardCategories.length);
                console.log('  Categories:', wizardCategories.map(c => c.id).join(', '));
                
                // Step 2: Defensive guards
                if (!wizardCategories || wizardCategories.length === 0) {
                    console.error('✗ ERROR: No categories! Using fallback.');
                    wizardCategories = [...baseWizardCategories];
                }
                
                if (!wizardDraft) {
                    wizardDraft = {};
                    console.log('✓ wizardDraft initialized');
                }
                
                // Step 3: UI Elements
                const confirmDialog = document.getElementById('wizardConfirm');
                const container = document.getElementById('wizardContainer');
                const content = document.getElementById('wizardContent');
                const errorDiv = document.getElementById('wizardError');
                
                console.log('✓ UI Elements:');
                console.log('  - confirmDialog:', !!confirmDialog);
                console.log('  - container:', !!container);
                console.log('  - content:', !!content);
                
                if (!confirmDialog || !container || !content) {
                    throw new Error('Critical UI elements missing');
                }
                
                // Step 4: Hide dialogs, show container
                confirmDialog.classList.remove('active'); // Use classList!
                if (errorDiv) errorDiv.classList.remove('active');
                container.classList.add('active');
                console.log('✓ Container shown (added .active class)');
                
                // Step 5: Reset state
                wizardCurrentStep = 0;
                console.log('✓ Current step set to 0');
                
                // Step 6: Load draft
                loadWizardDraft();
                console.log('✓ Draft loaded');
                
                // Step 7: Render dots
                renderWizardProgressDots();
                console.log('✓ Progress dots rendered');
                
                // Step 8: Render steps
                renderWizardSteps();
                console.log('✓ Steps rendered');
                
                // Step 9: Wait for DOM, then update UI
                setTimeout(() => {
                    console.log('--- Delayed UI Update (50ms) ---');
                    
                    try {
                        // Update UI
                        updateWizardUI();
                        console.log('✓ UI updated');
                        
                        // Check if first step is visible
                        const firstStep = document.getElementById('wizard-step-0');
                        if (firstStep) {
                            const hasActive = firstStep.classList.contains('active');
                            const styles = window.getComputedStyle(firstStep);
                            
                            console.log('✓ First step check:');
                            console.log('  - Element exists:', !!firstStep);
                            console.log('  - Has .active class:', hasActive);
                            console.log('  - Display:', styles.display);
                            console.log('  - Opacity:', styles.opacity);
                            
                            // NUCLEAR FIX: Force visible if needed
                            if (!hasActive || styles.display === 'none') {
                                console.warn('⚠ First step not visible! Forcing...');
                                firstStep.classList.add('active');
                                console.log('✓ First step FORCED visible');
                            }
                        } else {
                            console.error('✗ ERROR: First step element not found!');
                            throw new Error('First step element not found');
                        }
                        
                        console.log('╔════════════════════════════════════╗');
                        console.log('║   WIZARD STARTED SUCCESSFULLY      ║');
                        console.log('╚════════════════════════════════════╝');
                    } catch (innerError) {
                        console.error('✗ Error in delayed UI update:', innerError);
                        showWizardError();
                    }
                }, 50);
                
            } catch (error) {
                console.error('╔════════════════════════════════════╗');
                console.error('║   WIZARD START FAILED              ║');
                console.error('╚════════════════════════════════════╝');
                console.error('Error details:', error);
                console.error('Stack trace:', error.stack);
                showWizardError();
            }
        }

        function cancelWizard() {
            const container = document.getElementById('wizardContainer');
            const confirmDialog = document.getElementById('wizardConfirm');
            if (container) container.classList.remove('active');
            if (confirmDialog) confirmDialog.classList.remove('active');
            switchView('home');
        }

        function closeWizard() {
            if (confirm('Möchtest du den Check-in wirklich abbrechen? Deine Eingaben werden als Entwurf gespeichert.')) {
                const container = document.getElementById('wizardContainer');
                const confirmDialog = document.getElementById('wizardConfirm');
                if (container) container.classList.remove('active');
                if (confirmDialog) confirmDialog.classList.remove('active');
                switchView('home');
            }
        }
        
        function showWizardError() {
            console.log('🚨 Showing error UI');
            const confirmDialog = document.getElementById('wizardConfirm');
            const container = document.getElementById('wizardContainer');
            const errorDiv = document.getElementById('wizardError');
            
            if (confirmDialog) confirmDialog.classList.remove('active');
            if (container) container.classList.remove('active');
            if (errorDiv) errorDiv.classList.add('active');
        }
        
        function retryWizard() {
            console.log('🔄 Retrying wizard...');
            const errorDiv = document.getElementById('wizardError');
            if (errorDiv) errorDiv.classList.remove('active');
            
            // Go back to confirm dialog
            switchView('checkin');
        }

        function renderWizardProgressDots() {
            const dotsContainer = safeGetElement('progressDots');
            if (!dotsContainer) return;
            
            dotsContainer.innerHTML = wizardCategories.map((_, i) => 
                `<div class="dot" data-step="${i}"></div>`
            ).join('');
        }

        function renderWizardSteps() {
            const content = safeGetElement('wizardContent');
            if (!content) {
                console.error('ERROR: wizardContent not found!');
                return;
            }
            
            content.innerHTML = '';
            
            console.log('Rendering', wizardCategories.length, 'wizard steps');
            
            // Render all categories
            wizardCategories.forEach((cat, index) => {
                const step = document.createElement('div');
                step.className = 'step-container-wizard';
                step.id = `wizard-step-${index}`;
                
                const isSleep = cat.isSleep;
                const defaultValue = isSleep ? (wizardDraft[cat.id] || 8.0) : (wizardDraft[cat.id] || 5);
                const maxValue = isSleep ? 12 : 10;
                const minValue = isSleep ? 0 : 1;
                const stepValue = isSleep ? 0.5 : 1;
                const displayValue = isSleep ? defaultValue.toFixed(1) : defaultValue;
                const labelText = isSleep ? 'Stunden' : 'von 10 Punkten';
                const minLabel = isSleep ? '0h' : 'Sehr schlecht';
                const maxLabel = isSleep ? '12h' : 'Perfekt';
                
                step.innerHTML = `
                    <div class="category-icon-wizard" style="background: ${cat.color}20; color: ${cat.color};">
                        ${categoryIcons[cat.id] || '?'}
                    </div>
                    <div class="step-title-wizard">${cat.name[currentLang] || cat.name}</div>
                    <div class="step-subtitle-wizard">${cat.hint[currentLang] || cat.hint}</div>
                    <div class="input-area-wizard">
                        <div class="slider-value-display-wizard">
                            <div class="slider-value-wizard" id="wizard-value-${cat.id}">${displayValue}</div>
                            <div class="slider-label-wizard">${labelText}</div>
                        </div>
                        <div style="padding: 0 12px;">
                            <input type="range" min="${minValue}" max="${maxValue}" step="${stepValue}" value="${defaultValue}" 
                                   class="slider-wizard" id="wizard-slider-${cat.id}" 
                                   oninput="updateWizardSliderValue('${cat.id}', this.value, ${isSleep})">
                            <div class="slider-labels-wizard">
                                <span>${minLabel}</span>
                                <span>${maxLabel}</span>
                            </div>
                        </div>
                    </div>
                `;
                content.appendChild(step);
            });

            // Render review step
            const reviewStep = document.createElement('div');
            reviewStep.className = 'step-container-wizard';
            reviewStep.id = 'wizard-step-review';
            reviewStep.innerHTML = `
                <div class="step-title-wizard">Zusammenfassung</div>
                <div class="step-subtitle-wizard">Überprüfe deine Angaben. Tippe auf eine Kategorie zum Bearbeiten.</div>
                <div class="review-list-wizard" id="wizardReviewList"></div>
            `;
            content.appendChild(reviewStep);
            
            console.log('Wizard steps rendered successfully');
        }

        function updateWizardSliderValue(id, value, isSleep = false) {
            const displayValue = isSleep ? parseFloat(value).toFixed(1) : value;
            document.getElementById(`wizard-value-${id}`).textContent = displayValue;
            wizardDraft[id] = parseFloat(value);
            saveWizardDraft();
        }

        function updateWizardUI() {
            const stepCounter = document.getElementById('stepCounter');
            const progressBar = document.getElementById('progressBarWizard');
            const backBtn = document.getElementById('backBtnWizard');
            const nextBtn = document.getElementById('nextBtnWizard');
            
            if (!stepCounter || !progressBar || !backBtn || !nextBtn) {
                console.error('Wizard UI elements not found');
                return;
            }
            
            const isReview = wizardCurrentStep === wizardCategories.length;
            stepCounter.textContent = 
                isReview ? 'Zusammenfassung' : `Schritt ${wizardCurrentStep + 1}/${wizardCategories.length}`;

            const progress = ((wizardCurrentStep + 1) / (wizardCategories.length + 1)) * 100;
            progressBar.style.width = progress + '%';

            document.querySelectorAll('.dot').forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i < wizardCurrentStep) dot.classList.add('completed');
                if (i === wizardCurrentStep) dot.classList.add('active');
            });

            backBtn.disabled = wizardCurrentStep === 0;

            // Handle ALL step containers (including review)
            document.querySelectorAll('.step-container-wizard').forEach((step, i) => {
                step.classList.remove('active', 'prev');
                
                // Regular steps (0 to length-1)
                if (i < wizardCategories.length) {
                    if (i === wizardCurrentStep) {
                        step.classList.add('active');
                    } else if (i < wizardCurrentStep) {
                        step.classList.add('prev');
                    }
                }
                // Review step (last one)
                else if (i === wizardCategories.length && isReview) {
                    step.classList.add('active');
                }
            });

            if (isReview) {
                nextBtn.textContent = '✓ Speichern';
                nextBtn.onclick = saveWizardCheckIn;
                updateWizardReviewList();
            } else {
                nextBtn.textContent = 'Weiter';
                nextBtn.onclick = wizardNextStep;
            }
        }

        function updateWizardReviewList() {
            const reviewList = document.getElementById('wizardReviewList');
            if (!reviewList) {
                console.error('wizardReviewList not found');
                return;
            }
            reviewList.innerHTML = wizardCategories.map((cat, index) => `
                <div class="review-item-wizard" onclick="goToWizardStep(${index})">
                    <div class="review-item-left-wizard">
                        <div class="review-icon-wizard" style="background: ${cat.color}20; color: ${cat.color};">
                            ${categoryIcons[cat.id] || cat.icon}
                        </div>
                        <div class="review-info-wizard">
                            <div class="review-category-wizard">${cat.name[currentLang]}</div>
                            <div class="review-hint-wizard">${cat.hint[currentLang]}</div>
                        </div>
                    </div>
                    <div class="review-value-wizard">${wizardDraft[cat.id] || (cat.id === 'sleep' ? '8.0' : '5')}</div>
                </div>
            `).join('');
        }

        function wizardNextStep() {
            if (wizardCurrentStep < wizardCategories.length) {
                wizardCurrentStep++;
                updateWizardUI();
            }
        }

        function goToWizardStep(step) {
            console.log('🔄 goToWizardStep called:', step);
            console.log('  Current step before:', wizardCurrentStep);
            wizardCurrentStep = step;
            console.log('  Current step after:', wizardCurrentStep);
            updateWizardUI();
            console.log('  ✓ UI updated - should show step', step);
        }

        document.addEventListener('click', function(e) {
            if (e.target.id === 'backBtnWizard') {
                if (wizardCurrentStep > 0) {
                    wizardCurrentStep--;
                    updateWizardUI();
                }
            }
        });

        function saveWizardDraft() {
            localStorage.setItem('fysWizardDraft', JSON.stringify(wizardDraft));
        }

        function loadWizardDraft() {
            const saved = localStorage.getItem('fysWizardDraft');
            if (saved) {
                wizardDraft = JSON.parse(saved);
            }
        }

        function saveWizardCheckIn() {
            console.log('=== SAVE WIZARD CHECK-IN START ===');
            console.log('Raw wizardDraft:', wizardDraft);
            
            // Get all values
            const values = {};
            const sleepHoursValue = parseFloat(wizardDraft.sleep) || 8.0;
            
            console.log('Sleep Hours Value (parsed):', sleepHoursValue);
            console.log('Sleep Goal:', sleepGoal);
            
            // Calculate sleep bonus: ±0.25 per 0.5h deviation
            const sleepGoalDiff = sleepHoursValue - sleepGoal;
            const halfHourDeviations = sleepGoalDiff / 0.5;
            const sleepBonus = halfHourDeviations * 0.25;
            
            // DEBUG LOGGING
            console.log('=== SLEEP CALCULATION DEBUG ===');
            console.log('Sleep Hours:', sleepHoursValue);
            console.log('Sleep Goal:', sleepGoal);
            console.log('Difference:', sleepGoalDiff);
            console.log('Half Hour Deviations:', halfHourDeviations);
            console.log('Sleep Bonus:', sleepBonus);
            
            // Collect all category values
            wizardCategories.forEach(cat => {
                if (!cat.isSleep) {
                    values[cat.id] = parseFloat(wizardDraft[cat.id]) || 5;
                    console.log(`${cat.id} value:`, values[cat.id]);
                }
            });
            
            console.log('Energy Input Value:', values.energy);
            console.log('All Input Values:', values);

            // Use existing submitCheckIn logic
            const isFirstEntry = performanceData.entries.length === 0;
            let entryDate;
            if (isFirstEntry) {
                entryDate = new Date();
            } else {
                const lastEntry = performanceData.entries[performanceData.entries.length - 1];
                entryDate = new Date(lastEntry.date);
                entryDate.setDate(entryDate.getDate() + 1);
            }

            let fysIndex;
            const categoryValues = {};
            const packIndices = {}; // Add pack indices

            if (isFirstEntry) {
                fysIndex = 100;
                categories.forEach(cat => {
                    categoryValues[cat.id] = 100;
                });
                
                // Initialize pack categories
                getActivePackCategories().forEach(cat => {
                    categoryValues[cat.id] = 100;
                });
                
                // Initialize pack indices
                performanceData.activePacks.forEach(packId => {
                    packIndices[packId] = 100;
                });
            } else {
                const lastEntry = performanceData.entries[performanceData.entries.length - 1];
                
                // Create adjusted values for FYS Index calculation
                // Sleep bonus is added to ENERGY INPUT before averaging
                const adjustedValuesForFYS = {};
                categories.forEach(cat => {
                    if (cat.id === 'energy') {
                        // Energy gets the sleep bonus added to its input value
                        // Example: energy input 9, sleep -4h → bonus -2
                        // For FYS average: 9 + (-2) = 7
                        adjustedValuesForFYS[cat.id] = (values[cat.id] || 5) + sleepBonus;
                        console.log('Adjusted Energy for FYS:', adjustedValuesForFYS[cat.id]);
                    } else {
                        adjustedValuesForFYS[cat.id] = values[cat.id] || 5;
                    }
                });
                
                console.log('All Adjusted Values for FYS:', adjustedValuesForFYS);
                
                // Calculate FYS Index with adjusted energy value
                fysIndex = calculateFYSIndex(adjustedValuesForFYS, lastEntry.fysIndex);
                
                console.log('New FYS Index:', fysIndex);
                
                // Now calculate categoryValues (BASE categories)
                categories.forEach(cat => {
                    const prevValue = lastEntry.categoryValues[cat.id] || 100;
                    
                    if (cat.id === 'energy') {
                        // For energy category value: use the adjusted input
                        // This means the category curve also reflects sleep
                        const adjustedInput = adjustedValuesForFYS[cat.id];
                        const dailyChange = adjustedInput - 5;
                        categoryValues[cat.id] = Math.max(0, prevValue + dailyChange);
                        
                        console.log('Energy Category Calculation:');
                        console.log('  Previous Value:', prevValue);
                        console.log('  Adjusted Input:', adjustedInput);
                        console.log('  Daily Change:', dailyChange);
                        console.log('  New Value:', categoryValues[cat.id]);
                    } else {
                        categoryValues[cat.id] = calculateCategoryValue(values[cat.id], prevValue);
                    }
                });
                
                // Calculate pack category values
                getActivePackCategories().forEach(cat => {
                    const prevValue = lastEntry.categoryValues[cat.id] || 100;
                    categoryValues[cat.id] = calculateCategoryValue(values[cat.id], prevValue);
                });
                
                // Calculate pack indices
                performanceData.activePacks.forEach(packId => {
                    const prevPackIndex = lastEntry.packIndices?.[packId] || 100;
                    packIndices[packId] = calculatePackIndex(packId, values, prevPackIndex);
                    console.log(`Pack ${packId} Index:`, packIndices[packId]);
                });
            }

            console.log('Final Category Values:', categoryValues);
            console.log('Final Pack Indices:', packIndices);
            console.log('=== END DEBUG ===');

            performanceData.entries.push({
                date: entryDate.toISOString(),
                values: values,
                categoryValues: categoryValues,
                sleepHours: sleepHoursValue,
                fysIndex: fysIndex,
                packIndices: packIndices // Add pack indices to entry
            });

            localStorage.setItem('fysData', JSON.stringify(performanceData));
            localStorage.removeItem('fysWizardDraft');

            // Set flag for post-reload actions (scroll + 1D reset)
            try {
                sessionStorage.setItem('fysCheckInCompleted', 'true');
                console.log('Post-checkin flag set successfully');
            } catch(e) {
                console.error('Could not set sessionStorage flag:', e);
            }

            showToast();

            setTimeout(() => {
                wizardDraft = {};
                // Navigate to home and set 1D timeframe
                switchView('home');
                setTimeout(() => {
                    changeTimeRange('1d');
                    highlightLatestDataPoint();
                }, 300);
            }, 1000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== PAGE LOAD ===');
            
            // Load saved timeRange
            const savedTimeRange = localStorage.getItem('fys_timeRange');
            if (savedTimeRange) {
                currentTimeRange = savedTimeRange;
                console.log('✓ Loaded saved timeRange:', savedTimeRange);
            }
            
            // Load active Performance Packs
            const savedActivePacks = localStorage.getItem('fys_activePacks');
            if (savedActivePacks) {
                try {
                    performanceData.activePacks = JSON.parse(savedActivePacks);
                    console.log('✓ Loaded active packs:', performanceData.activePacks);
                } catch (e) {
                    console.error('Error loading active packs:', e);
                }
            }
            
            let postCheckinFlag = false;
            try {
                postCheckinFlag = sessionStorage.getItem('fysCheckInCompleted') === 'true';
                console.log('Post-checkin flag:', postCheckinFlag);
            } catch(e) {
                console.error('SessionStorage error:', e);
            }
            
            // Hide loading screen after content loads
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
            }, 800);
            
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            document.querySelectorAll('[data-theme-btn]').forEach(el => el.classList.remove('active'));
            const themeBtn = document.querySelector(`[data-theme-btn="${currentTheme}"]`);
            if (themeBtn) themeBtn.classList.add('active');
            
            if (coachDataAccess) {
                const toggle = document.getElementById('coachDataToggle');
                if (toggle) toggle.classList.add('active');
            }
            
            initMainChart();
            updateUI();
            renderPerformancePacks(); // Show active packs immediately
            
            // Check if we just completed a check-in
            if (postCheckinFlag) {
                console.log('POST-CHECKIN MODE ACTIVATED');
                console.log('Current timerange before:', currentTimeRange);
                
                // Reset to 1D timeframe
                changeTimeRange('1d');
                
                console.log('Current timerange after:', currentTimeRange);
                
                // Scroll to top after a brief delay to ensure content is rendered
                setTimeout(() => {
                    console.log('Scrolling to top...');
                    window.scrollTo({ top: 0, behavior: 'instant' });
                    const homeView = document.getElementById('homeView');
                    if (homeView) {
                        homeView.scrollTo({ top: 0, behavior: 'instant' });
                        console.log('Scrolled home view to top');
                    }
                }, 100);
                
                // Clear the flag
                try {
                    sessionStorage.removeItem('fysCheckInCompleted');
                    console.log('Flag cleared');
                } catch(e) {
                    console.error('Could not clear flag:', e);
                }
            } else {
                console.log('NORMAL LOAD MODE');
                // Normal load - apply saved timerange
                changeTimeRange(currentTimeRange);
            }
            
            createStockList();
            updateJournalStats();
            renderPerformancePacks(); // Render Performance Packs on home
            
            // Setup IntersectionObserver for sticky checkin widget
            const checkinWidget = document.querySelector('.checkin-widget');
            if (checkinWidget && 'IntersectionObserver' in window) {
                const observerOptions = {
                    root: null,
                    threshold: [0, 1],
                    rootMargin: '-1px 0px 0px 0px'
                };
                
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.intersectionRatio < 1) {
                            entry.target.classList.add('is-sticky');
                        } else {
                            entry.target.classList.remove('is-sticky');
                        }
                    });
                }, observerOptions);
                
                observer.observe(checkinWidget);
                console.log('✓ IntersectionObserver setup for sticky widget');
            }
        });
        // ============================================
        // PERFORMANCE PACK CARD ON HOME
        // ============================================
        
        // ============================================
        // ENHANCED CATEGORY DETAILS
        // ============================================
        
        function calculateCategoryIndexInfluence(categoryId) {
            const entries = performanceData.entries;
            if (entries.length < 2) return 0;
            
            const latest = entries[entries.length - 1];
            const previous = entries[entries.length - 2];
            
            const categoryValue = latest.categoryValues?.[categoryId] || 100;
            const prevCategoryValue = previous.categoryValues?.[categoryId] || 100;
            const categoryChange = categoryValue - prevCategoryValue;
            
            const indexValue = latest.fysIndex;
            const prevIndexValue = previous.fysIndex;
            const indexChange = indexValue - prevIndexValue;
            
            if (indexChange === 0) return 0;
            return (categoryChange / indexChange) * 100;
        }

        function getTrendLabel(trend) {
            return {
                'bullish': '📈 Bullish',
                'bearish': '📉 Bearish',
                'neutral': '➡️ Neutral'
            }[trend] || '➡️ Neutral';
        }

        function renderRecentCheckins(categoryId) {
            const container = document.getElementById('recentCheckinsList');
            if (!container) return;
            
            const entries = performanceData.entries.slice(-5).reverse();
            
            if (entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">Keine Check-ins vorhanden</div>';
                return;
            }
            
            container.innerHTML = entries.map(entry => {
                const date = new Date(entry.date);
                const value = entry.categoryValues?.[categoryId] || 100;
                const rating = entry.ratings?.[categoryId] || 5;
                
                return `
                    <div class="checkin-item">
                        <div class="checkin-date">${date.toLocaleDateString('de-DE')}</div>
                        <div class="checkin-rating">${'⭐'.repeat(rating)}</div>
                        <div class="checkin-value">${value.toFixed(1)}</div>
                    </div>
                `;
            }).join('');
        }

        // Override openCategoryDetail to add enhanced features
        const originalOpenCategoryDetailFunc = typeof openCategoryDetail !== 'undefined' ? openCategoryDetail : null;

        function openCategoryDetailEnhanced(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            currentCategoryId = categoryId;
            
            const modal = safeGetElement('categoryDetailModal');
            const header = safeGetElement('categoryDetailHeader');
            const content = safeGetElement('categoryDetailContent');
            
            if (!modal || !header || !content) return;
            
            const entries = getFilteredEntries();
            let currentValue = 100;
            let changeValue = 0;
            let changePercent = 0;
            let trend = 'neutral';
            
            if (entries.length > 0) {
                const latest = entries[entries.length - 1];
                currentValue = latest.categoryValues?.[categoryId] || 100;
                
                if (entries.length > 1) {
                    const first = entries[0];
                    const firstValue = first.categoryValues?.[categoryId] || 100;
                    changeValue = currentValue - firstValue;
                    changePercent = (changeValue / firstValue) * 100;
                    
                    if (changePercent > 5) trend = 'bullish';
                    else if (changePercent < -5) trend = 'bearish';
                }
            }
            
            const indexInfluence = calculateCategoryIndexInfluence(categoryId);
            const iconHtml = categoryIcons[categoryId] || category.icon;
            
            header.innerHTML = `
                <div class="category-detail-icon" style="background: ${category.color}20; color: ${category.color};">
                    ${iconHtml}
                </div>
                <div class="category-detail-info">
                    <div class="category-detail-name">${category.name[currentLang]}</div>
                    <div class="category-detail-symbol">
                        ${category.id.toUpperCase()} 
                        <span class="trend-badge ${trend}">${getTrendLabel(trend)}</span>
                    </div>
                </div>
                <button class="close-btn" onclick="closeCategoryDetail()">×</button>
            `;
            
            content.innerHTML = `
                <div class="category-detail-price-section">
                    <div class="category-detail-price" style="color: ${changeValue >= 0 ? 'var(--accent-up)' : 'var(--accent-down)'};">
                        ${currentValue.toFixed(1)}
                    </div>
                    <div class="category-detail-change" style="background: ${changeValue >= 0 ? 'rgba(0, 255, 136, 0.1)' : 'rgba(255, 51, 102, 0.1)'}; color: ${changeValue >= 0 ? 'var(--accent-up)' : 'var(--accent-down)'};">
                        ${changeValue >= 0 ? '▲' : '▼'} ${Math.abs(changePercent).toFixed(2)}%
                    </div>
                </div>
                
                <div class="category-influence-card">
                    <div class="influence-title">Index Influence</div>
                    <div class="influence-value">${indexInfluence >= 0 ? '+' : ''}${indexInfluence.toFixed(2)}%</div>
                    <div class="influence-description">Impact on ${getActiveIndexName()}</div>
                </div>
                
                <div class="category-time-selector">
                    <button class="category-time-btn active" onclick="changeCategoryTimeRange('1d')" data-range="1d">1D</button>
                    <button class="category-time-btn" onclick="changeCategoryTimeRange('7d')" data-range="7d">7D</button>
                    <button class="category-time-btn" onclick="changeCategoryTimeRange('1m')" data-range="1m">1M</button>
                    <button class="category-time-btn" onclick="changeCategoryTimeRange('6m')" data-range="6m">6M</button>
                    <button class="category-time-btn" onclick="changeCategoryTimeRange('1y')" data-range="1y">1Y</button>
                    <button class="category-time-btn" onclick="changeCategoryTimeRange('all')" data-range="all">MAX</button>
                </div>
                
                <div class="category-chart-card">
                    <div class="category-chart-container">
                        <canvas id="categoryDetailChart"></canvas>
                    </div>
                </div>
                
                <div class="recent-checkins-card">
                    <div class="checkins-title">Recent Check-ins</div>
                    <div id="recentCheckinsList"></div>
                </div>
            `;
            
            modal.classList.add('active');
            
            setTimeout(() => {
                initCategoryDetailChart();
                updateCategoryDetailChart();
                renderRecentCheckins(categoryId);
            }, 100);
        }

        // Use enhanced version
        if (typeof openCategoryDetail !== 'undefined') {
            openCategoryDetail = openCategoryDetailEnhanced;
        }

        // ============================================
        // WIZARD SUMMARY FLOW (IMPROVED)
        // ============================================
        
        let summaryEditMode = false;
        let editingCategoryIndex = null;

        function showWizardSummary() {
            wizardCurrentStep = wizardCategories.length;
            updateWizardUI();
            
            const content = safeGetElement('wizardContent');
            if (!content) return;
            
            content.innerHTML = `
                <div class="summary-container">
                    <div class="summary-title">Zusammenfassung</div>
                    <div class="summary-subtitle">Überprüfe deine Angaben</div>
                    
                    <div class="summary-list" id="summaryListItems"></div>
                    
                    <div class="summary-actions">
                        <button class="btn-secondary" onclick="editLastCategory()">
                            Letzte Kategorie bearbeiten
                        </button>
                        <button class="btn-primary-wizard" onclick="saveWizardCheckIn()">
                            ✓ Speichern & Abschließen
                        </button>
                    </div>
                </div>
            `;
            
            const summaryList = safeGetElement('summaryListItems');
            if (summaryList) {
                summaryList.innerHTML = wizardCategories.map((cat, index) => `
                    <div class="summary-item" onclick="editCategory(${index})">
                        <div class="summary-item-left">
                            <div class="summary-icon" style="background: ${cat.color}20; color: ${cat.color};">
                                ${categoryIcons[cat.id] || cat.icon}
                            </div>
                            <div style="font-size: 14px; font-weight: 500;">${cat.name[currentLang]}</div>
                        </div>
                        <div class="summary-value">${wizardDraft[cat.id] || (cat.isSleep ? '8.0' : '5')}</div>
                    </div>
                `).join('');
            }
        }

        function editCategory(index) {
            summaryEditMode = true;
            editingCategoryIndex = index;
            wizardCurrentStep = index;
            updateWizardUI();
            
            const nextBtn = safeGetElement('nextBtnWizard');
            if (nextBtn) {
                nextBtn.textContent = 'Zurück zur Übersicht';
                nextBtn.onclick = () => {
                    summaryEditMode = false;
                    showWizardSummary();
                };
            }
        }

        function editLastCategory() {
            const lastIndex = wizardCategories.length - 1;
            editCategory(lastIndex);
        }

        // Update wizardNextStep to go to summary
        const originalWizardNextStep = wizardNextStep;
        wizardNextStep = function() {
            if (wizardCurrentStep < wizardCategories.length - 1) {
                wizardCurrentStep++;
                updateWizardUI();
            } else {
                // Last category done → go to summary
                showWizardSummary();
            }
        };

        // ============================================
        // NEW FEATURES - 10 MAJOR UPDATES
        // ============================================

        // Active Pack Context for dynamic titles
        let activePackContext = null;

        function getActiveIndexName() {
            if (activePackContext && activePackContext.id) {
                return activePackContext.name;
            }
            return 'FYS Index';
        }

        // ============================================
        // TOOLS VIEW FUNCTIONS
        // ============================================
        
        function openPerformanceReport() {
            if (!isPro) {
                showUpgradeModal();
                return;
            }
            generatePDFReport();
        }

        function openStatistics() {
            alert('📈 Detailed statistics dashboard coming soon!');
        }

        function openProFeatures() {
            if (!isPro) {
                showUpgradeModal();
            } else {
                alert('⭐ You already have Pro! Explore all features in the app.');
            }
        }

        function showUpgradeModal() {
            const modal = safeGetElement('upgradeModal');
            if (modal) modal.classList.add('active');
        }

        function closeUpgradeModal() {
            const modal = safeGetElement('upgradeModal');
            if (modal) modal.classList.remove('active');
        }

        function activateProFromModal() {
            togglePro();
            closeUpgradeModal();
            alert('🎉 FYS Pro aktiviert! Alle Features sind jetzt freigeschaltet.');
        }

        // ============================================
        // PDF EXPORT FUNCTION
        // ============================================
        
        async function generatePDFReport() {
            try {
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    alert('⚠️ PDF Bibliothek wird geladen...\n\nBitte versuche es in wenigen Sekunden erneut.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // ===== HEADER =====
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 107, 53); // Orange
                doc.text('FYS Performance Report', 20, 20);
                
                // Active Index Name
                const indexName = getActiveIndexName();
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text(indexName, 20, 35);
                
                // Date Range
                const entries = performanceData.entries;
                if (entries.length > 0) {
                    const first = new Date(entries[0].date);
                    const last = new Date(entries[entries.length - 1].date);
                    const dateRange = `${first.toLocaleDateString('de-DE')} - ${last.toLocaleDateString('de-DE')}`;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text(dateRange, 20, 45);
                    doc.setTextColor(0, 0, 0);
                }
                
                // ===== CHART IMAGE =====
                const chartCanvas = document.getElementById('mainChart');
                if (chartCanvas) {
                    try {
                        const chartImage = chartCanvas.toDataURL('image/png');
                        doc.addImage(chartImage, 'PNG', 20, 55, 170, 80);
                    } catch (e) {
                        console.error('Chart image error:', e);
                    }
                }
                
                // ===== PERFORMANCE TABLE =====
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Performance Overview', 20, 145);
                
                const tableData = [];
                if (entries.length > 0) {
                    const latest = entries[entries.length - 1];
                    const previous = entries.length > 1 ? entries[entries.length - 2] : null;
                    
                    categories.forEach(cat => {
                        const current = latest.categoryValues?.[cat.id] || 100;
                        const prev = previous ? (previous.categoryValues?.[cat.id] || 100) : 100;
                        const change = current - prev;
                        const trend = change > 0 ? '↑' : change < 0 ? '↓' : '→';
                        
                        tableData.push([
                            cat.name.de || cat.name,
                            current.toFixed(1),
                            `${change >= 0 ? '+' : ''}${change.toFixed(1)}`,
                            trend
                        ]);
                    });
                }
                
                doc.autoTable({
                    startY: 155,
                    head: [['Category', 'Current', 'Change', 'Trend']],
                    body: tableData,
                    theme: 'grid',
                    styles: { 
                        fontSize: 9,
                        font: 'helvetica'
                    },
                    headStyles: { 
                        fillColor: [255, 107, 53],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    }
                });
                
                // ===== FOOTER =====
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(
                        `Page ${i} of ${pageCount} | Generated: ${new Date().toLocaleString('de-DE')}`,
                        doc.internal.pageSize.width / 2,
                        doc.internal.pageSize.height - 10,
                        { align: 'center' }
                    );
                }
                
                // ===== SAVE =====
                const filename = `FYS_Report_${indexName.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
                doc.save(filename);
                
                alert('✅ PDF Report erfolgreich heruntergeladen!');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('❌ Fehler beim Erstellen des PDFs. Bitte versuche es erneut.');
            }
        }

        // ============================================
        // AUTO 1D TIMEFRAME AFTER CHECK-IN
        // ============================================
        
        // Update saveWizardCheckIn to include auto 1D switch
        const originalSaveWizardCheckIn = saveWizardCheckIn;
        saveWizardCheckIn = function() {
            // Call original function
            if (typeof originalSaveWizardCheckIn === 'function') {
                originalSaveWizardCheckIn();
            }
            
            // Set flags for post-checkin behavior
            sessionStorage.setItem('fysCheckInCompleted', 'true');
            sessionStorage.setItem('fysAutoTimeframe', '1d');
            
            // Navigate to home and apply 1D
            setTimeout(() => {
                switchView('home');
                changeTimeRange('1d');
                highlightLatestDataPoint();
            }, 300);
        };

        function highlightLatestDataPoint() {
            if (mainChart && mainChart.data.datasets[0]) {
                const lastIndex = mainChart.data.datasets[0].data.length - 1;
                if (lastIndex >= 0) {
                    // Reset all points
                    mainChart.data.datasets[0].pointRadius = Array(lastIndex + 1).fill(0);
                    mainChart.data.datasets[0].pointBackgroundColor = Array(lastIndex + 1).fill('transparent');
                    
                    // Highlight latest
                    mainChart.data.datasets[0].pointRadius[lastIndex] = 6;
                    mainChart.data.datasets[0].pointBackgroundColor[lastIndex] = '#ff6b35';
                    mainChart.data.datasets[0].pointBorderColor = Array(lastIndex + 1).fill('transparent');
                    mainChart.data.datasets[0].pointBorderColor[lastIndex] = '#ffffff';
                    mainChart.data.datasets[0].pointBorderWidth = Array(lastIndex + 1).fill(0);
                    mainChart.data.datasets[0].pointBorderWidth[lastIndex] = 2;
                    
                    mainChart.update();
                }
            }
        }

        // ============================================
        // DYNAMIC TITLE UPDATES
        // ============================================
        
        // Override openPackDetails to set active pack context
        const originalOpenPackDetails = openPackDetails;
        openPackDetails = function(packId) {
            const pack = performancePacks.find(p => p.id === packId);
            if (pack) {
                activePackContext = { id: pack.id, name: pack.name };
            }
            
            if (typeof originalOpenPackDetails === 'function') {
                originalOpenPackDetails(packId);
            }
        };

        // Override closeChartDetails to reset context
        const originalCloseChartDetails = closeChartDetails;
        closeChartDetails = function() {
            activePackContext = null;
            
            if (typeof originalCloseChartDetails === 'function') {
                originalCloseChartDetails();
            }
        };

    </script>
</body>
</html>
